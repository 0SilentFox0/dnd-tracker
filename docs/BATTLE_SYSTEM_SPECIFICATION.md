# D&D Battle System - –ü–æ–≤–Ω–µ –¢–µ—Ö–Ω—ñ—á–Ω–µ –ó–∞–≤–¥–∞–Ω–Ω—è

## üìã –ó–ê–ì–ê–õ–¨–ù–ò–ô –û–ì–õ–Ø–î

–ë–æ–π–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è D&D –¥–æ–¥–∞—Ç–∫—É –∑ real-time —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—î—é —á–µ—Ä–µ–∑ WebSockets, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∞–º–∏ —É—Ä–æ–Ω—É/–ª—ñ–∫—É–≤–∞–Ω–Ω—è, –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Å–∫–ª–∞–¥–Ω–∏—Ö –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤, –ø–∞—Å–∏–≤–Ω–∏—Ö –∑–¥—ñ–±–Ω–æ—Å—Ç–µ–π, –µ—Ñ–µ–∫—Ç—ñ–≤ —Ç–∞ —Å–∏—Å—Ç–µ–º–∏ –º–æ—Ä–∞–ª—ñ.

### Tech Stack:
- Next.js App Router
- Neon PostgreSQL
- shadcn/ui –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
- WebSockets (Pusher/Ably –∞–±–æ –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç)
- Tailwind CSS (mobile-first)

---

## üóÑÔ∏è –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ò–•

### 1. BattleScene (–°—Ü–µ–Ω–∞ –ë–æ—é)

```typescript
{
  id: string;                    // —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä
  campaignId: string;            // –¥–æ —è–∫–æ—ó –∫–∞–º–ø–∞–Ω—ñ—ó –Ω–∞–ª–µ–∂–∏—Ç—å
  name: string;                  // –Ω–∞–∑–≤–∞ –±–∏—Ç–≤–∏
  description?: string;          // –æ–ø–∏—Å (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
  status: "prepared" | "active" | "completed";  // —Å—Ç–∞–Ω –±–∏—Ç–≤–∏
  currentRound: number;          // –Ω–æ–º–µ—Ä –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–∞—É–Ω–¥—É (–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ 1)
  currentTurnIndex: number;      // —ñ–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞ –≤ –º–∞—Å–∏–≤—ñ initiativeOrder
  result?: "victory" | "defeat" | null;  // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–∏—Ç–≤–∏
  participants: Array<{          // —Å–ø–∏—Å–æ–∫ —É—á–∞—Å–Ω–∏–∫—ñ–≤ —â–æ –±—É–ª–∏ –æ–±—Ä–∞–Ω—ñ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ
    sourceId: string;            // ID –ø–µ—Ä—Å–æ–Ω–∞–∂–∞/—é–Ω—ñ—Ç–∞
    type: "character" | "unit";
    side: "ally" | "enemy";
    quantity?: number;           // –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–¥–ª—è units –º–æ–∂–µ –±—É—Ç–∏ >1)
  }>;
  initiativeOrder: BattleParticipant[];  // —á–µ—Ä–≥–∞ —Ö–æ–¥—ñ–≤, —Å–æ—Ä—Ç–æ–≤–∞–Ω–∞ –ø–æ initiative
  pendingSummons: Array<{        // –ø—Ä–∏–∑–≤–∞–Ω—ñ —ñ—Å—Ç–æ—Ç–∏ —â–æ –∑'—è–≤–ª—è—Ç—å—Å—è –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —Ä–∞—É–Ω–¥–∞—Ö
    id: string;
    name: string;
    initiative: number;
    // ... –¥–∞–Ω—ñ –ø—Ä–∏–∑–≤–∞–Ω–æ—ó —ñ—Å—Ç–æ—Ç–∏
  }>;
  createdAt: Date;
  startedAt?: Date;
  completedAt?: Date;
}
```

### 2. BattleParticipant (–£—á–∞—Å–Ω–∏–∫ –≤ –ê–∫—Ç–∏–≤–Ω–æ–º—É –ë–æ—é)

–¶–µ –ø–æ–≤–Ω–∞ –∫–æ–ø—ñ—è character –∞–±–æ unit –∑ –∞–∫—Ç—É–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ –¥–ª—è –±–æ—é.

#### –ë–∞–∑–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:
```typescript
{
  id: string;                    // —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID —É—á–∞—Å–Ω–∏–∫–∞ –í –¶–Ü–ô –ë–ò–¢–í–Ü
  battleId: string;              // ID –±–∏—Ç–≤–∏
  sourceId: string;              // –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π ID character/unit
  sourceType: "character" | "unit";
  instanceNumber?: number;       // –Ω–æ–º–µ—Ä –∫–æ–ø—ñ—ó (–¥–ª—è units: 1, 2, 3...)
  name: string;                  // —ñ–º'—è
  avatar?: string;               // –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  side: "ally" | "enemy";       // —Å—Ç–æ—Ä–æ–Ω–∞
  controlledBy: string;          // userId (–¥–ª—è players) –∞–±–æ "dm" (–¥–ª—è NPC/units)
}
```

#### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
```typescript
{
  level: number;                 // —Ä—ñ–≤–µ–Ω—å
  initiative: number;            // –ø–æ—Ç–æ—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞—Ç–∏–≤–∞ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –±–æ–Ω—É—Å—ñ–≤)
  baseInitiative: number;        // –±–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞—Ç–∏–≤–∞ (–±–µ–∑ —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö –±–æ–Ω—É—Å—ñ–≤)
  strength: number;
  dexterity: number;
  constitution: number;
  intelligence: number;
  wisdom: number;
  charisma: number;
  modifiers: {                   // —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω—ñ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    strength: number;            // (stat - 10) / 2 rounded down
    dexterity: number;
    // ... –¥–ª—è –≤—Å—ñ—Ö 6 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
  };
  proficiencyBonus: number;      // –±–æ–Ω—É—Å –º–∞–π—Å—Ç–µ—Ä–Ω–æ—Å—Ç—ñ
  race: string;                  // —Ä–∞—Å–∞ (human, elf, necromancer, demon, —Ç–æ—â–æ)
}
```

#### –ë–æ–π–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:
```typescript
{
  maxHp: number;                 // –º–∞–∫—Å–∏–º—É–º –∑–¥–æ—Ä–æ–≤'—è
  currentHp: number;             // –ø–æ—Ç–æ—á–Ω–µ –∑–¥–æ—Ä–æ–≤'—è
  tempHp: number;                // —Ç–∏–º—á–∞—Å–æ–≤—ñ HP
  armorClass: number;            // –∫–ª–∞—Å –∑–∞—Ö–∏—Å—Ç—É (AC)
  morale: number;                // –º–æ—Ä–∞–ª—å (–≤—ñ–¥ -3 –¥–æ +3, default 0)
  status: "active" | "unconscious" | "dead";
}
```

#### –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è (—è–∫—â–æ –∫–∞—Å—Ç–µ—Ä):
```typescript
{
  spellcastingClass?: string;    // –∫–ª–∞—Å –∑–∞–∫–ª–∏–Ω–∞–Ω—å
  spellcastingAbility?: "intelligence" | "wisdom" | "charisma";
  spellSaveDC?: number;          // —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∏–π DC –¥–ª—è saving throws
  spellAttackBonus?: number;     // –±–æ–Ω—É—Å –¥–æ –∞—Ç–∞–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è–º
  spellSlots: {                  // –æ–±'—î–∫—Ç –∑ —Ä—ñ–≤–Ω—è–º–∏ 1-5
    "1": { max: number; current: number };
    "2": { max: number; current: number };
    // ... –¥–æ 5
  };
  knownSpells: string[];         // –º–∞—Å–∏–≤ ID –∑–∞–∫–ª–∏–Ω–∞–Ω—å
}
```

#### –ê—Ç–∞–∫–∏:
```typescript
{
  attacks: Array<{
    id?: string;
    name: string;
    type: "melee" | "ranged";
    attackBonus: number;         // –±–∞–∑–æ–≤–∏–π –±–æ–Ω—É—Å
    damageDice: string;          // "2d6", "1d8+3" —Ç–æ—â–æ
    damageType: string;          // slashing, piercing, fire, —Ç–æ—â–æ
    range?: string;              // –¥–ª—è ranged
    properties?: string;         // —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ
  }>;
}
```

#### –ê–∫—Ç–∏–≤–Ω—ñ –µ—Ñ–µ–∫—Ç–∏:
```typescript
{
  activeEffects: Array<{
    id: string;
    name: string;
    type: "buff" | "debuff" | "condition";
    description?: string;
    icon?: string;
    duration: number;            // –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–∞—É–Ω–¥—ñ–≤ —â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
    appliedAt: {                 // –∫–æ–ª–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ
      round: number;
      timestamp: Date;
    };
    effects: Array<{             // –º–∞—Å–∏–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
      type: string;              // attack_bonus, ac_bonus, poison_damage, —Ç–æ—â–æ
      value: number;             // –∑–Ω–∞—á–µ–Ω–Ω—è
      isPercentage?: boolean;    // —á–∏ —Ü–µ –≤—ñ–¥—Å–æ—Ç–æ–∫
      damageType?: string;       // –¥–ª—è DOT: fire, poison, —Ç–æ—â–æ
    }>;
    dotDamage?: {                // –¥–ª—è —É—Ä–æ–Ω—É –∫–æ–∂–µ–Ω —Ä–∞—É–Ω–¥
      damagePerRound: number;
      damageType: string;
    };
  }>;
}
```

#### –ü–∞—Å–∏–≤–Ω—ñ –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ:
```typescript
{
  passiveAbilities: Array<{
    id: string;
    name: string;
    description: string;
    trigger: {                   // –∫–æ–ª–∏ —Å–ø—Ä–∞—Ü—å–æ–≤—É—î
      type: "always" | "on_hit" | "on_attack" | "ally_low_hp" | "start_of_turn" | "end_of_turn" | ...;
      condition?: string;        // —É–º–æ–≤–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "ally_hp <= 15%")
      chance?: number;           // –≤—ñ–¥—Å–æ—Ç–æ–∫ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è (25%, 20%)
    };
    effect: {                    // —â–æ —Ä–æ–±–∏—Ç—å (–æ–±'—î–∫—Ç –∑ –¥–µ—Ç–∞–ª—è–º–∏)
      type: string;
      value?: number;
      // ... —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–æ–ª—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É
    };
  }>;
}
```

#### –†–∞—Å–æ–≤—ñ –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ:
```typescript
{
  racialAbilities: Array<{
    id: string;
    name: string;
    effect: object;              // –¥–µ—Ç–∞–ª—ñ –µ—Ñ–µ–∫—Ç—É
    // –ù–∞–ø—Ä–∏–∫–ª–∞–¥: fire_immunity, magic_resistance, morale_rules
  }>;
}
```

#### –ü—Ä–æ–∫–∞—á–∫–∞ (–¥–µ—Ä–µ–≤–æ —Å–∫—ñ–ª—ñ–≤):
```typescript
{
  activeSkills: Array<{          // –º–∞—Å–∏–≤ —Å–∫—ñ–ª—ñ–≤ –∑ –¥–µ—Ä–µ–≤–∞ –ø—Ä–æ–∫–∞—á–∫–∏
    skillId: string;
    name: string;
    mainSkillId: string;
    level: "basic" | "advanced" | "expert";
    effects: Array<{             // –º–∞—Å–∏–≤ –±–æ–Ω—É—Å—ñ–≤
      type: string;              // —Ç–∏–ø –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∞ (melee_damage_percent, —Ç–æ—â–æ)
      value: number;             // –∑–Ω–∞—á–µ–Ω–Ω—è
      isPercentage: boolean;     // —á–∏ –≤—ñ–¥—Å–æ—Ç–æ–∫
    }>;
    spellEnhancements?: {        // –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è
      spellEffectIncrease?: number;  // +25% –µ—Ñ–µ–∫—Ç—É
      spellTargetChange?: { target: string };  // –∑–º—ñ–Ω–∞ —Ü—ñ–ª—ñ
      spellAdditionalModifier?: {    // –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä
        modifier?: string;           // "burning", "poison", —Ç–æ—â–æ
        damageDice?: string;         // "1d6" –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —à–∫–æ–¥–∏
        duration?: number;           // —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –≤ —Ä–∞—É–Ω–¥–∞—Ö
      };
      spellNewSpellId?: string;  // –Ω–æ–≤–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è
    };
  }>;
}
```

#### –ï–∫—ñ–ø—ñ—Ä–æ–≤–∞–Ω—ñ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏:
```typescript
{
  equippedArtifacts: Array<{
    artifactId: string;
    name: string;
    slot: string;                // weapon, shield, cloak, ring, helmet, amulet, item
    bonuses: Record<string, number>;  // –±–æ–Ω—É—Å–∏ –¥–æ —Å—Ç–∞—Ç—ñ–≤
    modifiers: Array<{           // –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ —É—Ä–æ–Ω—É/—Ç–æ—â–æ
      type: string;
      value: number;
      isPercentage?: boolean;
    }>;
    passiveAbility?: object;     // –ø–∞—Å–∏–≤–Ω–∞ –∑–¥—ñ–±–Ω—ñ—Å—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É
  }>;
}
```

#### –§–ª–∞–≥–∏ –¥—ñ–π:
```typescript
{
  hasUsedAction: boolean;        // —á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –æ—Å–Ω–æ–≤–Ω—É –¥—ñ—é
  hasUsedBonusAction: boolean;   // —á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –±–æ–Ω—É—Å–Ω—É –¥—ñ—é
  hasUsedReaction: boolean;      // —á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ —Ä–µ–∞–∫—Ü—ñ—é (–∫–æ–Ω—Ç—Ä-—É–¥–∞—Ä)
  hasExtraTurn: boolean;         // —á–∏ —î –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ö—ñ–¥ –≤—ñ–¥ –º–æ—Ä–∞–ª—ñ
}
```

### 3. BattleAction (–î—ñ—è –≤ –ë–æ—é)

–ö–æ–∂–Ω–∞ –¥—ñ—è –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó —Ç–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥–º—ñ–Ω–∏.

```typescript
{
  id: string;                    // —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä
  battleId: string;              // ID –±–∏—Ç–≤–∏
  round: number;                 // –≤ —è–∫–æ–º—É —Ä–∞—É–Ω–¥—ñ
  actionIndex: number;           // –ø–æ—Ä—è–¥–∫–æ–≤–∏–π –Ω–æ–º–µ—Ä –¥—ñ—ó (–¥–ª—è –≤—ñ–¥–º—ñ–Ω–∏)
  timestamp: Date;               // —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
  actorId: string;               // ID —É—á–∞—Å–Ω–∏–∫–∞ —â–æ –≤–∏–∫–æ–Ω–∞–≤ –¥—ñ—é
  actorName: string;             // —ñ–º'—è –∞–∫—Ç–æ—Ä–∞
  actorSide: "ally" | "enemy";
  actionType: "attack" | "spell" | "bonus_action" | "ability" | "end_turn" | "skip_turn" | "morale_skip";
  targets: Array<{               // –º–∞—Å–∏–≤ —Ü—ñ–ª–µ–π
    participantId: string;
    participantName: string;
  }>;
  actionDetails: {               // –æ–±'—î–∫—Ç –∑ –¥–µ—Ç–∞–ª—è–º–∏ (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–∏–ø—É)
    // –î–ª—è –∞—Ç–∞–∫:
    weaponName?: string;
    attackRoll?: number;
    attackBonus?: number;
    totalAttackValue?: number;
    targetAC?: number;
    isHit?: boolean;
    isCritical?: boolean;
    isCriticalFail?: boolean;
    // –î–ª—è —É—Ä–æ–Ω—É:
    damageRolls?: Array<{ dice: string; results: number[]; total: number; damageType: string }>;
    totalDamage?: number;
    damageBreakdown?: string;    // –¥–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —É—Ä–æ–Ω—É
    // –î–ª—è –∑–∞–∫–ª–∏–Ω–∞–Ω—å:
    spellId?: string;
    spellName?: string;
    spellLevel?: number;
    spellSlotUsed?: number;
    // –î–ª—è saving throws:
    savingThrows?: Array<{ participantId: string; ability: string; roll: number; result: "success" | "fail" }>;
    // –î–ª—è –ª—ñ–∫—É–≤–∞–Ω–Ω—è:
    healingRolls?: Array<{ dice: string; results: number[]; total: number }>;
    totalHealing?: number;
    // –î–ª—è –µ—Ñ–µ–∫—Ç—ñ–≤:
    appliedEffects?: Array<{ id: string; name: string; duration: number }>;
    // –î–ª—è –ø–∞—Å–∏–≤–æ–∫:
    triggeredAbilities?: Array<{ id: string; name: string }>;
    // –î–ª—è –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤:
    appliedModifiers?: Array<{ type: string; value: number; source: string }>;
  };
  resultText: string;            // —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å –¥–ª—è –ª–æ–≥–∞
  hpChanges: Array<{             // –º–∞—Å–∏–≤ –∑–º—ñ–Ω HP
    participantId: string;
    participantName: string;
    oldHp: number;
    newHp: number;
    change: number;              // –ø–æ–∑–∏—Ç–∏–≤–Ω–µ = —É—Ä–æ–Ω, –Ω–µ–≥–∞—Ç–∏–≤–Ω–µ = –ª—ñ–∫—É–≤–∞–Ω–Ω—è
  }>;
  isCancelled: boolean;          // —á–∏ –±—É–ª–∞ –≤—ñ–¥–º—ñ–Ω–µ–Ω–∞ –¥—ñ—è
  cancelledAt?: Date;            // –∫–æ–ª–∏ –≤—ñ–¥–º—ñ–Ω–µ–Ω–∞
}
```

### 4. CriticalEffect (–ö—Ä–∏—Ç–∏—á–Ω—ñ –ï—Ñ–µ–∫—Ç–∏)

–ë–∞–∑–∞ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ –¥–ª—è 1 —Ç–∞ 20 –Ω–∞ d20.

```typescript
{
  id: string;
  campaignId: string;
  type: "success" | "fail";      // success (–¥–ª—è 20) –∞–±–æ fail (–¥–ª—è 1)
  name: string;                  // –Ω–∞–∑–≤–∞ –µ—Ñ–µ–∫—Ç—É
  description: string;           // –æ–ø–∏—Å —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è
  rarity: number;                // –≤—ñ–¥ 1 –¥–æ 10 (–¥–ª—è –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –≤–∏–±–æ—Ä—É)
  effect: {                      // –æ–±'—î–∫—Ç –∑ –¥–µ—Ç–∞–ª—è–º–∏
    type: string;                // extra_damage, stun, disarm, heal, damage_self, weapon_break, —Ç–æ—â–æ
    value?: number;              // —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    duration?: number;           // —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (–¥–ª—è –µ—Ñ–µ–∫—Ç—ñ–≤)
    targetStat?: string;         // —è–∫–∞ —Å—Ç–∞—Ç–∞ –∑–º—ñ–Ω—é—î—Ç—å—Å—è
  };
  flavorText: string;            // —Ç–µ–∫—Å—Ç —â–æ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –≥—Ä–∞–≤—Ü—é
}
```

---

## üéØ –ê–õ–ì–û–†–ò–¢–ú –°–¢–í–û–†–ï–ù–ù–Ø –¢–ê –ó–ê–ü–£–°–ö–£ –ë–û–Æ

### –ö–†–û–ö 1: –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –°—Ü–µ–Ω–∏ (Prepared Battle)

**–ï–∫—Ä–∞–Ω:** `/campaigns/[id]/dm/battles/new`

–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏:
- –ü–æ–ª—è –¥–ª—è –Ω–∞–∑–≤–∏ —Ç–∞ –æ–ø–∏—Å—É –±–∏—Ç–≤–∏
- –°–ø–∏—Å–æ–∫ Player Characters –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏
- –°–ø–∏—Å–æ–∫ NPC Heroes –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏
- –°–ø–∏—Å–æ–∫ NPC Units –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏ —Ç–∞ –ø–æ–ª–µ–º –¥–ª—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ (quantity)
- –î–≤–∞ —Å—Ç–æ–≤–ø—Ü—ñ –¥–ª—è —Ä–æ–∑–ø–æ–¥—ñ–ª—É: "–°–æ—é–∑–Ω–∏–∫–∏" —Ç–∞ "–í–æ—Ä–æ–≥–∏"
- Drag & drop –º—ñ–∂ —Å—Ç–æ–≤–ø—Ü—è–º–∏ –¥–ª—è —Ä–æ–∑–ø–æ–¥—ñ–ª—É —É—á–∞—Å–Ω–∏–∫—ñ–≤
- –ö–Ω–æ–ø–∫–∏ "–ó–±–µ—Ä–µ–≥—Ç–∏" —Ç–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏"

**–õ–æ–≥—ñ–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ:**
- –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å BattleScene –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º `prepared`
- –ó–±–µ—Ä–µ–≥—Ç–∏ –º–∞—Å–∏–≤ `participants` –∑ –æ–±—Ä–∞–Ω–∏–º–∏ —É—á–∞—Å–Ω–∏–∫–∞–º–∏
- Redirect –Ω–∞ `/campaigns/[id]/dm/battles/[battleId]`

**–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –¥—É–±–ª—é–≤–∞–Ω–Ω—è:**
- –ö–Ω–æ–ø–∫–∞ "–î—É–±–ª—é–≤–∞—Ç–∏" –±—ñ–ª—è —ñ—Å–Ω—É—é—á–∏—Ö —Å—Ü–µ–Ω
- –ö–æ–ø—ñ—é—î –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ —Ç–∞ —ó—Ö —Ä–æ–∑–ø–æ–¥—ñ–ª
- –°—Ç–≤–æ—Ä—é—î –Ω–æ–≤—É —Å—Ü–µ–Ω—É –∑ —Ç–∏–º–∏ –∂ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

### –ö–†–û–ö 2: –ó–∞–ø—É—Å–∫ –ë–∏—Ç–≤–∏ (Start Battle)

**–ö–Ω–æ–ø–∫–∞:** "START BATTLE" –Ω–∞ –µ–∫—Ä–∞–Ω—ñ `/campaigns/[id]/dm/battles/[battleId]`

**–õ–æ–≥—ñ–∫–∞ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ:**

1. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è BattleParticipant –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞:**
   - –î–ª—è –∫–æ–∂–Ω–æ–≥–æ `character`: –ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ (HP, —Å—Ç–∞—Ç–∏, –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏, —Å–∫—ñ–ª–∏, –ø–∞—Å–∏–≤–∫–∏, –∞—Ç–∞–∫–∏)
   - –î–ª—è `units` –∑ `quantity > 1`: —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–∫—Ä–µ–º—ñ —ñ–Ω—Å—Ç–∞–Ω—Å–∏ –∑ `instanceNumber` (1, 2, 3...)
   - –ö–æ–∂–µ–Ω —É—á–∞—Å–Ω–∏–∫ –æ—Ç—Ä–∏–º—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π `battleParticipantId`

2. **–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ Initiative:**
   - –í–∑—è—Ç–∏ –±–∞–∑–æ–≤—É `initiative` –∑ –∫–æ–∂–Ω–æ–≥–æ `character/unit`
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –§–∞–π–¥–∞–µ–Ω "–∑–∞–≤–∂–¥–∏ –ø–µ—Ä—à–∏–π" = initiative 999)
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ –±–æ–Ω—É—Å–∏ –¥–æ initiative

3. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è initiativeOrder:**
   - –í—ñ–¥—Å–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ –∑–∞ `initiative` (–±—ñ–ª—å—à–∞ = –≤–∏—â–µ)
   - –ü—Ä–∏ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö `initiative` - —Å–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ `baseInitiative`
   - –ü—Ä–∏ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö `baseInitiative` - –∑–∞ `dexterity`

4. **–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤:**
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –∑ "–Ω–∞ –ø–æ—á–∞—Ç–∫—É –±–æ—é"
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–∞—Å–∏–≤–∫–∏ –∑ `trigger.type === "start_of_battle"`

5. **–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –±–∏—Ç–≤–∏:**
   - `status = "active"`
   - `currentRound = 1`
   - `currentTurnIndex = 0`
   - `startedAt = now()`

6. **WebSocket –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:**
   - –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å—ñ–º –≥—Ä–∞–≤—Ü—è–º –ø–æ–¥—ñ—é `battle_started`
   - –ö–Ω–æ–ø–∫–∞ "JOIN BATTLE" —Å—Ç–∞—î –∞–∫—Ç–∏–≤–Ω–æ—é —ñ —Å–≤—ñ—Ç–∏—Ç—å—Å—è –¥–ª—è –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤

---

## üéÆ –Ü–ù–¢–ï–†–§–ï–ô–° –ê–ö–¢–ò–í–ù–û–ì–û –ë–û–Æ

### –ó–∞–≥–∞–ª—å–Ω–∏–π –í–∏–≥–ª—è–¥

**URL:** `/campaigns/[id]/battles/[battleId]/play`

**Layout:**
- –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å: –ù–∞–∑–≤–∞ –±–∏—Ç–≤–∏, –Ω–æ–º–µ—Ä —Ä–∞—É–Ω–¥—É, –∫–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –•—ñ–¥"
- –î–≤–∞ —Å—Ç–æ–≤–ø—Ü—ñ: –°–æ—é–∑–Ω–∏–∫–∏ (–ª—ñ–≤–æ—Ä—É—á) —Ç–∞ –í–æ—Ä–æ–≥–∏ (–ø—Ä–∞–≤–æ—Ä—É—á)
- –ö–æ–∂–µ–Ω —É—á–∞—Å–Ω–∏–∫ –ø–æ–∫–∞–∑–∞–Ω–∏–π –∫–∞—Ä—Ç–∫–æ—é
- –í–Ω–∏–∑—É: –ü–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –¥—ñ–π
- –ó–Ω–∏–∑—É (–∑–≥–æ—Ä—Ç–∞—î—Ç—å—Å—è): –õ–æ–≥ –±–æ—é

### –ö–∞—Ä—Ç–∫–∞ –£—á–∞—Å–Ω–∏–∫–∞ (ParticipantCard)

**–î–ª—è –°–æ—é–∑–Ω–∏–∫—ñ–≤ (–≤–∏–¥–∏–º—ñ—Å—Ç—å –¥–ª—è –≥—Ä–∞–≤—Ü—ñ–≤):**
- –ê–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
- –Ü–º'—è
- Initiative (—á–∏—Å–ª–æ –∑ —ñ–∫–æ–Ω–∫–æ—é ‚ö°)
- HP: —á–∏—Å–ª–æ + –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä + –≤—ñ–¥—Å–æ—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: ‚ù§Ô∏è 38/45 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 84%)
- Temp HP (—è–∫—â–æ —î)
- –ê–∫—Ç–∏–≤–Ω—ñ –µ—Ñ–µ–∫—Ç–∏: —ñ–∫–æ–Ω–∫–∏ –∑ tooltip (–Ω–∞–∑–≤–∞ + —Å–∫—ñ–ª—å–∫–∏ —Ä–∞—É–Ω–¥—ñ–≤ –∑–∞–ª–∏—à–∏–ª–æ—Å—å)
- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ö–æ–¥—É: "‚≠ê –¢–í–Ü–ô –•–Ü–î" —è–∫—â–æ —Ü–µ —Ö—ñ–¥ —Ü—å–æ–≥–æ –≥—Ä–∞–≤—Ü—è
- –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Ä–∞–º–∫–æ—é –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞

**–î–ª—è –í–æ—Ä–æ–≥—ñ–≤ (–≤–∏–¥–∏–º—ñ—Å—Ç—å –¥–ª—è –≥—Ä–∞–≤—Ü—ñ–≤):**
- –ê–≤–∞—Ç–∞—Ä
- –Ü–º'—è
- Initiative (—á–∏—Å–ª–æ)
- HP: –¢–Ü–õ–¨–ö–ò –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –ë–ï–ó —á–∏—Å–ª–∞
- –ê–∫—Ç–∏–≤–Ω—ñ –µ—Ñ–µ–∫—Ç–∏: —ñ–∫–æ–Ω–∫–∏

**–î–ª—è DM:**
- –ë–∞—á–∏—Ç—å –í–°–Ü —á–∏—Å–ª–∞ HP –¥–ª—è –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤
- –ú–æ–∂–µ –∫–ª—ñ–∫–Ω—É—Ç–∏ –Ω–∞ –±—É–¥—å-—è–∫–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞ ‚Üí –¥–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
- –ú–æ–∂–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —Ö—ñ–¥ –±—É–¥—å-–∫–æ–≥–æ
- –ú–æ–∂–µ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ –¥—ñ—ó

### –ü–∞–Ω–µ–ª—å –î—ñ–π (ActionPanel)

**–ö–Ω–æ–ø–∫–∏:**
- ‚öîÔ∏è **–ê—Ç–∞–∫—É–≤–∞—Ç–∏** - —è–∫—â–æ `!hasUsedAction`
- ‚ú® **–ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è** - —è–∫—â–æ `!hasUsedAction` —ñ —î –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è
- ‚≠ê **–ë–æ–Ω—É—Å –î—ñ—è** - —è–∫—â–æ `!hasUsedBonusAction`
- ‚û°Ô∏è **–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –•—ñ–¥** - –∑–∞–≤–∂–¥–∏ –¥–æ—Å—Ç—É–ø–Ω–∞

–ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –∫–Ω–æ–ø–∫–∏:
- –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –ø–æ–ø–∞–ø/modal –¥–ª—è –≤–∏–±–æ—Ä—É –¥–µ—Ç–∞–ª–µ–π

---

## ‚öîÔ∏è –î–ï–¢–ê–õ–¨–ù–ò–ô –ê–õ–ì–û–†–ò–¢–ú –•–û–î–£

### 1. –ü–û–ß–ê–¢–û–ö –•–û–î–£ (Start of Turn)

**–¢—Ä–∏–≥–µ—Ä:** –ö–æ–ª–∏ `currentTurnIndex` –≤–∫–∞–∑—É—î –Ω–∞ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞

**–ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å:**

#### A. –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–º—É –≥—Ä–∞–≤—Ü—é:
- –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–ø–∞–ø "üéØ –¢–≤—ñ–π —Ö—ñ–¥!" –∑ —ñ–º–µ–Ω–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Ç–∞ HP
- WebSocket –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î notification —Ç—ñ–ª—å–∫–∏ —Ü—å–æ–º—É –≥—Ä–∞–≤—Ü—é
- –Ü–Ω—à—ñ –≥—Ä–∞–≤—Ü—ñ –±–∞—á–∞—Ç—å —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ß–µ–∫–∞—î–º–æ –Ω–∞ [–Ü–º'—è]..."

#### B. –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è DOT (Damage Over Time) –µ—Ñ–µ–∫—Ç—ñ–≤:
- –ü—Ä–æ–π—Ç–∏—Å—è –ø–æ –≤—Å—ñ—Ö `activeEffects` —É—á–∞—Å–Ω–∏–∫–∞
- –Ø–∫—â–æ –µ—Ñ–µ–∫—Ç –º–∞—î `dotDamage` - –≤—ñ–¥–Ω—è—Ç–∏ `damagePerRound` –≤—ñ–¥ `currentHp`
- –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ –ª–æ–≥ –±–æ—é
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ HP > 0 (—è–∫—â–æ –Ω—ñ - `unconscious`)

#### C. –ó–º–µ–Ω—à–µ–Ω–Ω—è —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –µ—Ñ–µ–∫—Ç—ñ–≤:
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ `effect` –≤ `activeEffects`: `duration = duration - 1`
- –í–∏–¥–∞–ª–∏—Ç–∏ –µ—Ñ–µ–∫—Ç–∏ –¥–µ `duration <= 0`
- –Ø–∫—â–æ –µ—Ñ–µ–∫—Ç –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è - –ø–æ–∫–∞–∑–∞—Ç–∏ notification

#### D. –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ "–Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ö–æ–¥—É":
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `passiveAbilities` –∑ `trigger.type === "start_of_turn"`
- –ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ê–≥—Ä–∞—ó–ª - –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –í–æ—Ä—ñ—Ç –ü–µ–∫–ª–∞ (–ø—Ä–∏–∑–∏–≤)
- –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å –±–æ–Ω—É—Å–Ω–æ—ó –¥—ñ—ó –¥–ª—è –ø—Ä–∏–∑–∏–≤—É —è–∫—â–æ:
  - –ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–∏–∑–≤–∞–Ω–∏—Ö < 3
  - `!hasUsedBonusAction`

#### E. –°–∫–∏–¥–∞–Ω–Ω—è —Ñ–ª–∞–≥—ñ–≤ –¥—ñ–π:
- `hasUsedAction = false`
- `hasUsedBonusAction = false`
- `hasUsedReaction = false`

### 2. –ü–ï–†–ï–í–Ü–†–ö–ê –ú–û–†–ê–õ–Ü (Morale Check)

**–£–º–æ–≤–∞:** –Ø–∫—â–æ `participant.currentMorale !== 0`

**–†–∞—Å–æ–≤—ñ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ (–∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –î–û –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏):**
- –Ø–∫—â–æ `race === "human"` —ñ `morale < 0`: –∑–º—ñ–Ω–∏—Ç–∏ `morale` –Ω–∞ 0
- –Ø–∫—â–æ `race === "necromancer"`: –∑–∞–≤–∂–¥–∏ `morale = 0` (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É)

**–ü–æ–ø–∞–ø –¥–ª—è –≥—Ä–∞–≤—Ü—è:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: "üé≤ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ú–æ—Ä–∞–ª—ñ"
- –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –º–æ—Ä–∞–ª—å —Ç–∞ —à–∞–Ω—Å
- –Ø–∫—â–æ –º–æ—Ä–∞–ª—å –ø–æ–∑–∏—Ç–∏–≤–Ω–∞: "–®–∞–Ω—Å –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ —Ö–æ–¥—É: [–º–æ—Ä–∞–ª—å √ó 10]%"
- –Ø–∫—â–æ –º–æ—Ä–∞–ª—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞: "–®–∞–Ω—Å –ø—Ä–æ–ø—É—Å–∫—É —Ö–æ–¥—É: [|–º–æ—Ä–∞–ª—å| √ó 10]%"
- –ü–æ–ª–µ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É 1d10
- –ö–Ω–æ–ø–∫–∞ "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏"

**–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫:**
- `moraleValue = Math.abs(currentMorale)`
- `chance = moraleValue √ó 10` (1 –º–æ—Ä–∞–ª—å = 10%, 2 = 20%, —Ç–æ—â–æ)
- –ì—Ä–∞–≤–µ—Ü—å –≤–≤–æ–¥–∏—Ç—å `roll` (—á–∏—Å–ª–æ –≤—ñ–¥ 1 –¥–æ 10)

**–Ø–∫—â–æ –º–æ—Ä–∞–ª—å > 0 (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞):**
- –Ø–∫—â–æ `roll <= chance`: —É—á–∞—Å–Ω–∏–∫ –æ—Ç—Ä–∏–º—É—î –î–û–î–ê–¢–ö–û–í–ò–ô –•–Ü–î –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ
- –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ `hasExtraTurn = true`
- –ü–æ–∫–∞–∑–∞—Ç–∏ notification –≤—Å—ñ–º: "‚≠ê [–Ü–º'—è] –æ—Ç—Ä–∏–º–∞–≤ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ö—ñ–¥!"
- –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ –ª–æ–≥

**–Ø–∫—â–æ –º–æ—Ä–∞–ª—å < 0 (–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞):**
- –Ø–∫—â–æ `roll <= chance`: —É—á–∞—Å–Ω–∏–∫ –ü–†–û–ü–£–°–ö–ê–Ñ –•–Ü–î
- –ü–æ–∫–∞–∑–∞—Ç–∏ notification: "üòî [–Ü–º'—è] –ø—Ä–æ–ø—É—Å—Ç–∏–≤ —Ö—ñ–¥ —á–µ—Ä–µ–∑ –Ω–∏–∑—å–∫—É –º–æ—Ä–∞–ª—å"
- –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ –ª–æ–≥ –∑ `actionType: "morale_skip"`
- –ü–µ—Ä–µ–π—Ç–∏ –æ–¥—Ä–∞–∑—É –¥–æ End Turn

### 3. –í–ò–ë–Ü–† –î–Ü–á

–ì—Ä–∞–≤–µ—Ü—å –æ–±–∏—Ä–∞—î –æ–¥–Ω—É –∑ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ –ø–∞–Ω–µ–ª—ñ –¥—ñ–π.

### 4. –ê–õ–ì–û–†–ò–¢–ú –ê–¢–ê–ö–ò

#### 4.1. –í–∏–±—ñ—Ä –ó–±—Ä–æ—ó

**–ü–æ–ø–∞–ø:** "‚öîÔ∏è –û–±–µ—Ä—ñ—Ç—å –ê—Ç–∞–∫—É"

- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∞—Ç–∞–∫ –∑ `attacks` –º–∞—Å–∏–≤—É
- –î–ª—è –∫–æ–∂–Ω–æ—ó –∞—Ç–∞–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–∏:
  - –ù–∞–∑–≤—É
  - –¢–∏–ø (Melee/Ranged)
  - –ë–æ–Ω—É—Å –¥–æ –∞—Ç–∞–∫–∏
  - –ö–æ—Å—Ç—ñ —É—Ä–æ–Ω—É —Ç–∞ —Ç–∏–ø —É—Ä–æ–Ω—É
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"

#### 4.2. –í–∏–±—ñ—Ä –¶—ñ–ª—ñ

**–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
- –í—Å—ñ —É—á–∞—Å–Ω–∏–∫–∏ –±–æ—é —Å—Ç–∞—é—Ç—å —á–µ–∫–±–æ–∫—Å–∞–º–∏
- –î–ª—è –∑–≤–∏—á–∞–π–Ω–æ—ó –∞—Ç–∞–∫–∏: –º–æ–∂–Ω–∞ –æ–±—Ä–∞—Ç–∏ –¢–Ü–õ–¨–ö–ò –û–î–ù–£ —Ü—ñ–ª—å
- –ü–æ–∫–∞–∑–∞—Ç–∏ AC –∫–æ–∂–Ω–æ—ó —Ü—ñ–ª—ñ
- –ü–æ–∫–∞–∑–∞—Ç–∏ HP bar –≤–æ—Ä–æ–≥—ñ–≤ (–±–µ–∑ —á–∏—Å–ª–∞ –¥–ª—è –≥—Ä–∞–≤—Ü—ñ–≤)
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∞—Ç–∞–∫—É–≤–∞—Ç–∏ —Å–æ—é–∑–Ω–∏–∫—ñ–≤ (friendly fire) - –î–û–°–¢–£–ü–ù–ê
- –ö–Ω–æ–ø–∫–∞ "–ê—Ç–∞–∫—É–≤–∞—Ç–∏"

#### 4.3. Attack Roll (–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ü–æ–ø–∞–¥–∞–Ω–Ω—è)

**–ü–æ–ø–∞–ø:** "üé≤ Attack Roll"

- –ü–æ–∫–∞–∑–∞—Ç–∏ –æ–±—Ä–∞–Ω—É —Ü—ñ–ª—å —Ç–∞ —ó—ó AC
- –ü–æ–ª–µ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É 1d20
- –ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∏–π –±–æ–Ω—É—Å –¥–æ –∞—Ç–∞–∫–∏:
  - –ë–∞–∑–æ–≤–∏–π `attackBonus` –∑—ñ –∑–±—Ä–æ—ó
  - Modifier —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (STR –¥–ª—è melee, DEX –¥–ª—è ranged)
  - `proficiencyBonus`
  - –ë–æ–Ω—É—Å–∏ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ü–∑–∞–±–µ–ª—å +2 ATK)
- –ü–æ–∫–∞–∑–∞—Ç–∏ —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–∏–Ω—É—Ç–∏ –¥–ª—è –ø–æ–ø–∞–¥–∞–Ω–Ω—è (`targetAC`)
- –ö–Ω–æ–ø–∫–∞ "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏"

**–°–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫ - Advantage (–ï–ª—å—Ñ–∏ –∑ ranged):**
- –Ø–∫—â–æ `race === "elf"` –Ü `weapon.type === "ranged"`:
  - –ü–æ–ø—Ä–æ—Å–∏—Ç–∏ –∫–∏–Ω—É—Ç–∏ 1d20 –î–í–Ü–ß–Ü
  - –ü–æ–∫–∞–∑–∞—Ç–∏ –æ–±–∏–¥–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
  - –í–∑—è—Ç–∏ –ö–†–ê–©–ò–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  - –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ –ª–æ–≥ "–ï–ª—å—Ñ—ñ–π—Å—å–∫–µ –≤–º—ñ–Ω–Ω—è: –∫–∏–Ω—É—Ç–æ X —ñ Y, –æ–±—Ä–∞–Ω–æ Z"

**–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫:**
- `totalAttackValue = d20Roll + attackBonus + statModifier + proficiencyBonus + effectBonuses`
- `isHit = totalAttackValue >= targetAC`

**–ö—Ä–∏—Ç–∏—á–Ω–µ –ø–æ–ø–∞–¥–∞–Ω–Ω—è (d20 = 20):**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–ø–∞–¥–∞–Ω–Ω—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ AC
- `isCritical = true`
- –í–∏–±—Ä–∞—Ç–∏ –í–ò–ü–ê–î–ö–û–í–ò–ô –∫—Ä–∏—Ç–∏—á–Ω–∏–π –µ—Ñ–µ–∫—Ç –∑ –±–∞–∑–∏ (`type: "success"`)
- –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞–∑–≤—É —Ç–∞ `flavorText` –µ—Ñ–µ–∫—Ç—É
- –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ `effect` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–æ–¥–∞—Ç–∏ stun –Ω–∞ 1 —Ä–∞—É–Ω–¥)
- –ü–æ–¥–≤–æ—ó—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫—É–±–∏–∫—ñ–≤ —É—Ä–æ–Ω—É (2d6 —Å—Ç–∞—î 4d6)

**–ö—Ä–∏—Ç–∏—á–Ω–∏–π –ø—Ä–æ–º–∞—Ö (d20 = 1):**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø—Ä–æ–º–∞—Ö –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ `totalAttackValue`
- `isCriticalFail = true`
- –í–∏–±—Ä–∞—Ç–∏ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –∫—Ä–∏—Ç–∏—á–Ω–∏–π –µ—Ñ–µ–∫—Ç (`type: "fail"`)
- –ü–æ–∫–∞–∑–∞—Ç–∏ –µ—Ñ–µ–∫—Ç (–º–æ–∂–ª–∏–≤–æ —É—Ä–æ–Ω —Å–æ–±—ñ, –≤—Ç—Ä–∞—Ç–∞ –∑–±—Ä–æ—ó, —Ç–æ—â–æ)
- –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∏–π –µ—Ñ–µ–∫—Ç
- –ó–ê–ö–Ü–ù–ß–ò–¢–ò –¥—ñ—é (–ø—Ä–æ–º–∞—Ö, —É—Ä–æ–Ω—É –Ω–µ–º–∞—î)

**–Ø–∫—â–æ –ø—Ä–æ–º–∞—Ö (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∏–π):**
- –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–ø–∞–ø: "‚ùå –ü—Ä–æ–º–∞—Ö!"
- –ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–∞ —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–ª–æ
- –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ –ª–æ–≥: "[–Ü–º'—è] –∞—Ç–∞–∫—É–≤–∞–≤ [–¶—ñ–ª—å] —Ç–∞ –ø—Ä–æ–º–∞—Ö–Ω—É–≤—Å—è (roll: X, –ø–æ—Ç—Ä—ñ–±–Ω–æ: Y)"
- –ó–ê–ö–Ü–ù–ß–ò–¢–ò –¥—ñ—é
- `hasUsedAction = true`

#### 4.4. Damage Roll (–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –£—Ä–æ–Ω—É)

**–ü–æ–ø–∞–ø:** "üí• Damage Roll"

- –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞–∑–≤—É –∑–±—Ä–æ—ó —Ç–∞ –∫–æ—Å—Ç—ñ —É—Ä–æ–Ω—É
- –Ø–∫—â–æ –∫—Ä–∏—Ç–∏—á–Ω–µ –ø–æ–ø–∞–¥–∞–Ω–Ω—è: –ü–û–î–í–û–á–¢–ò –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫—É–±–∏–∫—ñ–≤
- –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–ª—è –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ö–û–ñ–ù–û–ì–û –∫—É–±–∏–∫–∞ –æ–∫—Ä–µ–º–æ
- –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è 2d6: –¥–≤–∞ –ø–æ–ª—è "–ö—É–±–∏–∫ 1: []" —Ç–∞ "–ö—É–±–∏–∫ 2: []"
- –ö–Ω–æ–ø–∫–∞ "–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –£—Ä–æ–Ω"

**–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–∑–æ–≤–æ–≥–æ —É—Ä–æ–Ω—É:**
- `baseDamage = —Å—É–º–∞ –≤—Å—ñ—Ö –≤–≤–µ–¥–µ–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å –∫—É–±–∏–∫—ñ–≤`
- –î–æ–¥–∞—Ç–∏ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (STR –¥–ª—è melee, DEX –¥–ª—è ranged)
- `totalPhysicalDamage = baseDamage + statModifier`

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è % –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤ (—Å—Ç–∞–∫—É—é—Ç—å—Å—è –∞–¥–∏—Ç–∏–≤–Ω–æ):**
- –ü—Ä–æ–π—Ç–∏—Å—è –ø–æ `activeSkills` —É—á–∞—Å–Ω–∏–∫–∞
- –ó–Ω–∞–π—Ç–∏ –µ—Ñ–µ–∫—Ç–∏ –¥–µ `type` –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ç–∏–ø—É –∞—Ç–∞–∫–∏:
  - `melee_damage` –¥–ª—è melee
  - `ranged_damage` –¥–ª—è ranged
  - `physical_damage` –¥–ª—è –±—É–¥—å-—è–∫–æ—ó —Ñ—ñ–∑–∏—á–Ω–æ—ó –∞—Ç–∞–∫–∏
- –Ø–∫—â–æ `isPercentage === true`: –¥–æ–¥–∞—Ç–∏ `value` –¥–æ `totalPercentage`
- –ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ë–∞–∑–æ–≤–∞ –ê—Ç–∞–∫–∞ +15% + –ü—Ä–æ—Å—É–Ω—É—Ç–∞ –ê—Ç–∞–∫–∞ +10% = +25% total
- `bonusDamage = Math.floor(totalPhysicalDamage √ó (totalPercentage / 100))`
- `totalPhysicalDamage += bonusDamage`

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤ –∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤:**
- –ü—Ä–æ–π—Ç–∏—Å—è –ø–æ `equippedArtifacts`
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ `modifier` —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ç–∏–ø—É –∞—Ç–∞–∫–∏:
  - –Ø–∫—â–æ `isPercentage`: —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ % –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ `totalDamage` —ñ –¥–æ–¥–∞—Ç–∏
  - –Ø–∫—â–æ –ù–ï percentage: –¥–æ–¥–∞—Ç–∏ `value` —è–∫ flat bonus

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–∞—Å–∏–≤–Ω–∏—Ö –∑–¥—ñ–±–Ω–æ—Å—Ç–µ–π:**
- –ü—Ä–æ–π—Ç–∏—Å—è –ø–æ `passiveAbilities`
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `trigger.condition`:
  - –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ì–æ–¥—Ä–∏–∫: "ally_low_hp"
  - –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ—Ö —Å–æ—é–∑–Ω–∏–∫—ñ–≤ (`same side`)
  - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î —Ö—Ç–æ—Å—å –∑ `(currentHp / maxHp) <= 0.15`
  - –Ø–∫—â–æ –¢–ê–ö: –¥–æ–¥–∞—Ç–∏ +50% –¥–æ `totalDamage`
  - –ü–æ–∫–∞–∑–∞—Ç–∏ notification –í–°–Ü–ú –≥—Ä–∞–≤—Ü—è–º: "‚ö° –ê–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ –ø–∞—Å–∏–≤–∫–∞ –ì–æ–¥—Ä–∏–∫–∞! +50% —É—Ä–æ–Ω—É"
- –î–ª—è –∑–¥—ñ–±–Ω–æ—Å—Ç–µ–π –∑ `chance` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 25%):
  - –ö–∏–Ω—É—Ç–∏ 1d100
  - –Ø–∫—â–æ <= `chance`: –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –µ—Ñ–µ–∫—Ç

**–î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ —É—Ä–æ–Ω—É (–≤–æ–≥–æ–Ω—å, –æ—Ç—Ä—É—Ç–∞, —Ç–æ—â–æ):**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `activeEffects` –∞—Ç–∞–∫—É—é—á–æ–≥–æ
- –ó–Ω–∞–π—Ç–∏ –µ—Ñ–µ–∫—Ç–∏ –∑ `type === "additional_damage"`
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–∞–∫–æ–≥–æ –µ—Ñ–µ–∫—Ç—É:
  - –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–ø–∞–ø –¥–ª—è –∫–∏–¥–∫–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –∫—É–±–∏–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 1d8 fire –≤—ñ–¥ –ê–≥—Ä–∞—ó–ª–∞)
  - –ì—Ä–∞–≤–µ—Ü—å –≤–≤–æ–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  - –î–æ–¥–∞—Ç–∏ –¥–æ –º–∞—Å–∏–≤—É `additionalDamage`: `{type: 'fire', value: roll}`

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ–ø–æ—Ä—É/—ñ–º—É–Ω—ñ—Ç–µ—Ç—É —Ü—ñ–ª—ñ:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `racialAbilities` —Ü—ñ–ª—ñ
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ `damageType` (physical, fire, poison, —Ç–æ—â–æ):
  - –Ø–∫—â–æ —î `immunity` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `fire_immunity` –¥–ª—è –¥–µ–º–æ–Ω—ñ–≤):
    - –£—Ä–æ–Ω —Ü—å–æ–≥–æ —Ç–∏–ø—É = 0
    - –î–æ–¥–∞—Ç–∏ –¥–æ breakdown: "[value] fire –Ü–ú–£–ù–Ü–¢–ï–¢ (0 —É—Ä–æ–Ω—É)"
  - –Ø–∫—â–æ —î `resistance` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `physical_resistance 50%`):
    - –£—Ä–æ–Ω = —É—Ä–æ–Ω √ó (1 - resistance%)
    - –î–æ–¥–∞—Ç–∏ –¥–æ breakdown: "-[value] (–æ–ø—ñ—Ä 50%)"

**–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ `finalTotalDamage = —Ñ—ñ–∑–∏—á–Ω–∏–π —É—Ä–æ–Ω + –≤—Å—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —É—Ä–æ–Ω–∏ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —ñ–º—É–Ω—ñ—Ç–µ—Ç—ñ–≤)`**

**–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–ø–∞–ø –∑ –¥–µ—Ç–∞–ª—å–Ω–∏–º —Ä–æ–∑–±–∏—Ç—Ç—è–º:
  - "X physical (–∫–æ—Å—Ç—ñ: [–∑–Ω–∞—á–µ–Ω–Ω—è])"
  - "+ Y (STR modifier)"
  - "+ Z (–ë–∞–∑–æ–≤–∞ –ê—Ç–∞–∫–∞ +15%)"
  - "+ W fire (–í–æ–≥–Ω—è–Ω–∏–π –º–µ—á)"
  - "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
  - "–í—Å—å–æ–≥–æ: [total] —É—Ä–æ–Ω—É"
  - "[–¶—ñ–ª—å]: [oldHP] ‚Üí [newHP]"

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —É—Ä–æ–Ω—É:**
- `target.currentHp -= finalTotalDamage`
- –Ø–∫—â–æ `currentHp < 0`: `currentHp = 0`
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–Ω (—è–∫—â–æ HP = 0 ‚Üí `unconscious`)

**–ó–∞–ø–∏—Å –¥—ñ—ó:**
- –°—Ç–≤–æ—Ä–∏—Ç–∏ `BattleAction` –∑ —É—Å—ñ–º–∞ –¥–µ—Ç–∞–ª—è–º–∏
- –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î
- –î–æ–¥–∞—Ç–∏ –¥–æ `battleLog`
- WebSocket broadcast –≤—Å—ñ–º

#### 4.5. –ö–æ–Ω—Ç—Ä-–£–¥–∞—Ä (Reaction)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –£ —Ü—ñ–ª—ñ —î `activeSkill` –∑ –Ω–∞–∑–≤–æ—é —â–æ –º—ñ—Å—Ç–∏—Ç—å "–ö–æ–Ω—Ç—Ä —É–¥–∞—Ä"
- `defender.hasUsedReaction === false`
- –¶–µ –ü–ï–†–®–ê –∞—Ç–∞–∫–∞ –Ω–∞ defender –≤ —Ü—å–æ–º—É —Ä–∞—É–Ω–¥—ñ

**–õ–æ–≥—ñ–∫–∞:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞—Ç–∞–∫ –Ω–∞ defender –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É —Ä–∞—É–Ω–¥—ñ
- –Ø–∫—â–æ —Ü–µ –ø–µ—Ä—à–∞ –∞—Ç–∞–∫–∞ –Ü —î —Å–∫—ñ–ª –∫–æ–Ω—Ç—Ä-—É–¥–∞—Ä—É:
  - –ü–æ–∫–∞–∑–∞—Ç–∏ notification –≤—Å—ñ–º: "‚ö° [–Ü–º'—è] –≤–∏–∫–æ–Ω—É—î –∫–æ–Ω—Ç—Ä-—É–¥–∞—Ä!"
  - `defender.hasUsedReaction = true`
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∞—Ç–∞–∫—É `defender ‚Üí attacker`:
    - –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø–µ—Ä—à—É –¥–æ—Å—Ç—É–ø–Ω—É –∞—Ç–∞–∫—É –∑ `attacks`
    - –ü—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Attack Roll
    - –ü—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Damage Roll
    - –î–û–î–ê–¢–ò +15% —É—Ä–æ–Ω—É (–∞–±–æ –∑–≥—ñ–¥–Ω–æ –∑—ñ —Å–∫—ñ–ª–æ–º)
  - –ó–∞–ø–∏—Å–∞—Ç–∏ –æ–∫—Ä–µ–º—É –¥—ñ—é –≤ –ª–æ–≥

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–∫—ñ–ª–∞ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–ª–µ –∑ –¥–µ—Ç–∞–ª—å–Ω–∏–º –ø—Å–µ–≤–¥–æ–∫–æ–¥–æ–≤–∏–º –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º —è–∫ –≤–æ–Ω–æ –ø—Ä–∞—Ü—é—î.

### 5. –ê–õ–ì–û–†–ò–¢–ú –ó–ê–ö–õ–ò–ù–ê–ù–ù–Ø

#### 5.1. –í–∏–±—ñ—Ä –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è

**–ü–æ–ø–∞–ø:** "‚ú® –ö–Ω–∏–≥–∞ –ó–∞–∫–ª–∏–Ω–∞–Ω—å"

- –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ spell slots:
  - Level 1: ‚óè‚óè‚óã‚óã (2/4)
  - Level 2: ‚óè‚óã‚óã (1/3)
  - —Ç–æ—â–æ
- –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö `knownSpells`
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è –ø–æ–∫–∞–∑–∞—Ç–∏:
  - –ù–∞–∑–≤—É
  - –†—ñ–≤–µ–Ω—å
  - –¢–∏–ø (Target/AOE)
  - –ö–ª–∞—Å (Damage/Heal)
  - –û–ø–∏—Å
  - –°–µ—Ä–µ–¥–Ω—è —à–∫–æ–¥–∞/–ª—ñ–∫—É–≤–∞–Ω–Ω—è
  - –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä

#### 5.2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è

–ü–µ—Ä–µ–¥ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –∫–∞—Å—Ç—É —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:

1. **Spell Slot:**
   - `spellSlots[spellLevel].current > 0`

2. **–û–±–º–µ–∂–µ–Ω–Ω—è –∑–¥—ñ–±–Ω–æ—Å—Ç–µ–π:**
   - –Ø–∫—â–æ –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è –ø—Ä–∏–≤'—è–∑–∞–Ω–µ –¥–æ —Å–∫—ñ–ª—É/–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å

3. **–û–±–º–µ–∂–µ–Ω–Ω—è —Ä–∞—Å / —ñ–º—É–Ω—ñ—Ç–µ—Ç—ñ–≤:**
   - –ù–∞–ø—Ä–∏–∫–ª–∞–¥: Fireball –ø—Ä–æ—Ç–∏ –¥–µ–º–æ–Ω—ñ–≤ ‚Äî –¥–æ–∑–≤–æ–ª–µ–Ω–æ, –∞–ª–µ —É—Ä–æ–Ω –±—É–¥–µ 0

4. **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –¥—ñ—ó:**
   - –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è –∑–∞–≤–∂–¥–∏ —Å–ø–æ–∂–∏–≤–∞—î –æ—Å–Ω–æ–≤–Ω—É –¥—ñ—é

**–ù–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è:**
- –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫—É
- –º–∞—é—Ç—å `disabled` state
- tooltip –∑ –ø—Ä–∏—á–∏–Ω–æ—é (No spell slots, Passive not unlocked, —Ç–æ—â–æ)

#### 5.3. –í–∏–±—ñ—Ä –¶—ñ–ª–µ–π –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è

**Target Spell:**
- –ì—Ä–∞–≤–µ—Ü—å –º–æ–∂–µ –æ–±—Ä–∞—Ç–∏ –æ–¥–Ω—É —Ü—ñ–ª—å
- –í—Å—ñ —É—á–∞—Å–Ω–∏–∫–∏ (–≤–∫–ª—é—á–Ω–æ –∑ —Å–æ—é–∑–Ω–∏–∫–∞–º–∏) –¥–æ—Å—Ç—É–ø–Ω—ñ

**AOE Spell:**
- –í—Å—ñ —É—á–∞—Å–Ω–∏–∫–∏ –±–æ—é –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è —è–∫ —á–µ–∫–±–æ–∫—Å–∏
- –ì—Ä–∞–≤–µ—Ü—å –°–ê–ú –æ–±–∏—Ä–∞—î, —Ö—Ç–æ –ø–æ—Ç—Ä–∞–ø–ª—è—î –≤ –æ–±–ª–∞—Å—Ç—å
- –Ø–∫—â–æ `spell` –º–∞—î `damageType` ‚Üí —É—Ä–∞–∂–∞—é—Ç—å—Å—è –≤—Å—ñ –æ–±—Ä–∞–Ω—ñ
- –Ø–∫—â–æ `spell` –º–∞—î `healType` ‚Üí –ª—ñ–∫—É—é—Ç—å—Å—è –≤—Å—ñ –æ–±—Ä–∞–Ω—ñ

#### 5.4. Saving Throws

–Ø–∫—â–æ `spell` –≤–∏–º–∞–≥–∞—î saving throw:

**–î–ª—è –∫–æ–∂–Ω–æ—ó —Ü—ñ–ª—ñ:**
- –ü–æ–∫–∞–∑–∞—Ç–∏ pop-up: "üé≤ Saving Throw: [DEX / CON / WIS]"
- –ì—Ä–∞–≤–µ—Ü—å (DM –∫–µ—Ä—É—î –≤–æ—Ä–æ–≥–∞–º–∏) –≤–≤–æ–¥–∏—Ç—å 1d20
- `totalSave = d20 + statModifier + bonuses`

**–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è:**
- –Ø–∫—â–æ `totalSave >= spellSaveDC` ‚Üí `success`
- –Ø–∫—â–æ < `spellSaveDC` ‚Üí `fail`

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ü–æ–≤–Ω–∏–π —É—Ä–æ–Ω / –µ—Ñ–µ–∫—Ç –ø—Ä–∏ `fail`
- –ü–æ–ª–æ–≤–∏–Ω–∞ —É—Ä–æ–Ω—É –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –µ—Ñ–µ–∫—Ç—É –ø—Ä–∏ `success` (–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ `spell`)

**–î–ª—è –¥–µ–º–æ–Ω—ñ–≤:**
- –Ø–∫—â–æ `damageType === "fire"` ‚Üí `finalDamage = 0` –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ save

#### 5.5. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –£—Ä–æ–Ω—É / –õ—ñ–∫—É–≤–∞–Ω–Ω—è –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è

–ê–ª–≥–æ—Ä–∏—Ç–º —ñ–¥–µ–Ω—Ç–∏—á–Ω–∏–π –¥–æ Damage Roll —Ñ—ñ–∑–∏—á–Ω–æ—ó –∞—Ç–∞–∫–∏, –∞–ª–µ:

- –ë–µ–∑ attack roll
- –ë–∞–∑–æ–≤–∏–π —É—Ä–æ–Ω –±–µ—Ä–µ—Ç—å—Å—è –∑ `spell.damageDice`
- –î–æ–¥–∞—é—Ç—å—Å—è:
  - –±–æ–Ω—É—Å–∏ –∑ –¥–µ—Ä–µ–≤–∞ –º–∞–≥—ñ—ó,
  - –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏,
  - –ø–∞—Å–∏–≤–Ω—ñ –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ,
  - –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ —Ä–∞—Å
- –í—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è:
  - resistance
  - immunity
  - vulnerability

**DOT / HOT –µ—Ñ–µ–∫—Ç–∏:**
- –¥–æ–¥–∞—é—Ç—å—Å—è –≤ `activeEffects` —Ü—ñ–ª—ñ
- `duration` + `dotDamage`

#### 5.6. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ö–∞—Å—Ç—É

- `spellSlots[level].current -= 1`
- `hasUsedAction = true`
- –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è `BattleAction`:
  - `actionType = "spell"`
  - WebSocket broadcast
  - –õ–æ–≥ –∑ –ø–æ–≤–Ω–∏–º breakdown

### 6. –ê–õ–ì–û–†–ò–¢–ú –ó–ê–í–ï–†–®–ï–ù–ù–Ø –•–û–î–£

#### 6.1. –ö–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –•—ñ–¥"

- –ì—Ä–∞–≤–µ—Ü—å —Å–∞–º –≤–∏—Ä—ñ—à—É—î, –∫–æ–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ö—ñ–¥
- –ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ:
  - `hasUsedAction` / `hasUsedBonusAction` –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è
  - –•—ñ–¥ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –ø—Ä–∏–º—É—Å–æ–≤–æ

#### 6.2. –û–±—Ä–æ–±–∫–∞ Extra Turn –≤—ñ–¥ –ú–æ—Ä–∞–ª—ñ

**–Ø–∫—â–æ:**
- `hasExtraTurn === true`

**–¢–æ–¥—ñ:**
- `hasExtraTurn = false`
- `currentTurnIndex` –ù–ï –∑–º—ñ–Ω—é—î—Ç—å—Å—è
- –£—á–∞—Å–Ω–∏–∫ –ø–æ—á–∏–Ω–∞—î –Ω–æ–≤–∏–π —Ö—ñ–¥
- –ü–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è Start of Turn

#### 6.3. –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –ù–∞—Å—Ç—É–ø–Ω–æ–≥–æ –£—á–∞—Å–Ω–∏–∫–∞

–Ø–∫—â–æ extra turn –Ω–µ–º–∞—î:
- `currentTurnIndex += 1`
- –Ø–∫—â–æ `currentTurnIndex >= initiativeOrder.length`:
  - `currentTurnIndex = 0`
  - `currentRound += 1`
  - –í–∏–∫–æ–Ω–∞—Ç–∏ Start of Round

### 7. –ü–û–ß–ê–¢–û–ö –ù–û–í–û–ì–û –†–ê–£–ù–î–£ (Start of Round)

1. **–ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ initiative:**
   - –í—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ –±–æ–Ω—É—Å–∏/–¥–µ–±–∞—Ñ–∏
   - –Ø–∫—â–æ –µ—Ñ–µ–∫—Ç –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è ‚Üí –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ `baseInitiative`
   - –ü–µ—Ä–µ—Å–æ—Ä—Ç—É–≤–∞—Ç–∏ `initiativeOrder`

2. **–î–æ–¥–∞—Ç–∏ pendingSummons:**
   - –í—Å—Ç–∞–≤–∏—Ç–∏ –≤ `initiativeOrder` –∑–≥—ñ–¥–Ω–æ `initiative`
   - –û—á–∏—Å—Ç–∏—Ç–∏ `pendingSummons`

3. **–ó–∞–ø–∏—Å —É –ª–æ–≥:**
   - "üîÅ –ü–æ—á–∞—Ç–æ–∫ –†–∞—É–Ω–¥—É X"

### 8. –ü–†–ò–ó–ò–í–ê–ù–ù–Ø (SUMMONS)

#### 8.1. –ó–∞–≥–∞–ª—å–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞

- –ü—Ä–∏–∑–∏–≤ = –±–æ–Ω—É—Å –¥—ñ—è
- –ú–∞–∫—Å–∏–º—É–º 3 —ñ—Å—Ç–æ—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
- –Ø–∫—â–æ –≤–∂–µ 3 ‚Üí –¥—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

**–ü—Ä–∏–∑–≤–∞–Ω—ñ —ñ—Å—Ç–æ—Ç–∏:**
- –æ—Ç—Ä–∏–º—É—é—Ç—å 200% —É—Ä–æ–Ω—É
- –º–∞—é—Ç—å –≤–ª–∞—Å–Ω—É initiative
- –∑'—è–≤–ª—è—é—Ç—å—Å—è –≤ –ù–ê–°–¢–£–ü–ù–û–ú–£ —Ä–∞—É–Ω–¥—ñ

#### 8.2. –ê–≥—Ä–∞—ó–ª ‚Äì –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –í–æ—Ä—ñ—Ç –ü–µ–∫–ª–∞

- **Trigger:** `start_of_turn`
- –Ø–∫—â–æ `!hasUsedBonusAction` —ñ `summoned < 3`:
  - –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É "–í—ñ–¥–∫—Ä–∏—Ç–∏ –í–æ—Ä–æ—Ç–∞ –ü–µ–∫–ª–∞"
  - –ü—Ä–∏–∑–∏–≤–∞—î—Ç—å—Å—è:
    - Tier –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä—ñ–≤–Ω—è —Å–∫—ñ–ª—É
    - –ó–∞–≤–∂–¥–∏ –æ–¥–Ω–∞ —ñ—Å—Ç–æ—Ç–∞
  - –î–æ–¥–∞—î—Ç—å—Å—è –≤ `pendingSummons`

### 9. –°–ú–ï–†–¢–¨, –ù–ï–ü–†–ò–¢–û–ú–ù–Ü–°–¢–¨, –ü–ï–†–ï–ú–û–ì–ê

#### 9.1. –ù–µ–ø—Ä–∏—Ç–æ–º–Ω—ñ—Å—Ç—å

- HP = 0 ‚Üí `status = "unconscious"`
- –ù–µ –º–æ–∂–µ –¥—ñ—è—Ç–∏
- –ú–æ–∂–µ –±—É—Ç–∏ –ø—ñ–¥–Ω—è—Ç–∏–π –ª—ñ–∫—É–≤–∞–Ω–Ω—è–º

#### 9.2. –ü–µ—Ä–µ–º–æ–≥–∞

–ë—ñ–π –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è, —è–∫—â–æ:
- –í—Å—ñ –≤–æ—Ä–æ–≥–∏ `unconscious` –∞–±–æ `dead`
- –ê–ë–û DM –∑–∞–≤–µ—Ä—à—É—î –≤—Ä—É—á–Ω—É

**–ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:**
- `status = "completed"`
- `result = "victory" | "defeat"`
- –í—Å—ñ `unconscious` —Å–æ—é–∑–Ω–∏–∫–∏ ‚Üí `HP = maxHp`

### 10. –Ü–°–¢–û–†–Ü–Ø –ë–û–Æ –¢–ê ROLLBACK

#### 10.1. Battle Log

- –í—Å—ñ `BattleAction` –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ
- DM –±–∞—á–∏—Ç—å:
  - –∫–Ω–æ–ø–∫—É ‚úèÔ∏è —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏
  - –∫–Ω–æ–ø–∫—É ‚ùå –≤–∏–¥–∞–ª–∏—Ç–∏

#### 10.2. –í—ñ–¥–º—ñ–Ω–∞ –î—ñ–π (Rollback)

**DM –º–æ–∂–µ:**
- –≤–∏–¥–∞–ª–∏—Ç–∏ –ë–£–î–¨-–Ø–ö–£ –¥—ñ—é

**–ü—Ä–∏ –≤—ñ–¥–º—ñ–Ω—ñ:**
- `isCancelled = true`
- –í—Å—ñ –∑–º—ñ–Ω–∏ HP, –µ—Ñ–µ–∫—Ç–∏, —Å–ª–æ—Ç–∏, summon ‚Äî –≤—ñ–¥–∫–æ—á—É—é—Ç—å—Å—è
- `currentTurnIndex` –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ –∞–∫—Ç–æ—Ä–∞
- WebSocket broadcast

**Rollback –ø—Ä–∞—Ü—é—î –Ω–∞ –≤–µ—Å—å –ª–æ–≥, –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å.**

### 11. –õ–û–ì–Ü–ö–ê –°–ö–Ü–õ–Ü–í, –ü–ê–°–ò–í–û–ö –¢–ê –¢–†–ò–ì–ï–†–Ü–í (–í–ê–ñ–õ–ò–í–ò–ô –ë–õ–û–ö)

#### 11.1. –Ñ–¥–∏–Ω–∞ –ú–æ–¥–µ–ª—å –ó–¥—ñ–±–Ω–æ—Å—Ç–µ–π

**–í–°–Ü –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ (—Å–∫—ñ–ª–∏, –ø–∞—Å–∏–≤–∫–∏, —Ä–∞—Å–æ–≤—ñ) –æ–ø–∏—Å—É—é—Ç—å—Å—è —è–∫:**

```typescript
{
  trigger: {
    type: "on_attack" | "on_hit" | "ally_low_hp" | "start_of_turn" | ...
    condition?: string;  // expression
  },
  effect: {
    type: "modify_damage" | "add_effect" | "summon" | ...
    value?: number;
    damageType?: string;
    duration?: number;
  }
}
```

#### 11.2. –û–±—Ä–æ–±–∫–∞

**–ü–µ—Ä–µ–¥ –∫–æ–∂–Ω–æ—é –¥—ñ—î—é:**
- –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ `passiveAbilities`
- –Ø–∫—â–æ `trigger` –≤–∏–∫–æ–Ω–∞–Ω–æ:
  - –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ `effect`
  - –∑–∞–ø–∏—Å–∞—Ç–∏ –≤ –ª–æ–≥
  - –ø–æ–∫–∞–∑–∞—Ç–∏ notification

**–¶–µ –¥–æ–∑–≤–æ–ª—è—î:**
- –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ –ë–ï–ó –∑–º—ñ–Ω–∏ –∫–æ–¥—É –±–æ—é
- –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ —Å–∏—Å—Ç–µ–º—É

### 12. AI / LLM –Ü–ù–¢–ï–ì–†–ê–¶–Ü–Ø (–û–¶–Ü–ù–ö–ê)

#### 12.1. –†–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥

**AI –ù–ï –ø–æ–≤–∏–Ω–µ–Ω:**
- –∑–º—ñ–Ω—é–≤–∞—Ç–∏ state –±–æ—é
- –∫–µ—Ä—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫–æ—é

**AI –ú–û–ñ–ï:**
- —Ä–∞—Ö—É–≤–∞—Ç–∏ —É—Ä–æ–Ω
- –ø–æ—è—Å–Ω—é–≤–∞—Ç–∏ —â–æ –≤—ñ–¥–±—É–ª–æ—Å—è
- –ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –¥—ñ—ó
- –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ flavor text
- –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ DM

#### 12.2. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

- –í–µ—Å—å battle state ‚Üí JSON
- –í—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –≤ AI —è–∫ read-only
- AI –ø–æ–≤–µ—Ä—Ç–∞—î:
  - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
  - —Ç–µ–∫—Å—Ç–æ–≤—ñ –ø–æ—è—Å–Ω–µ–Ω–Ω—è
- –ñ–û–î–ù–û–ì–û –≤–ø–ª–∏–≤—É –Ω–∞ state

**–¶–µ –±–µ–∑–ø–µ—á–Ω–æ —ñ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–æ.**
