# Аналіз скілів для бою

Усі скіли з `docs/SKILLS.md` мають враховуватися під час сцени бою. Нижче — зведення за ефектами та тригерами, що вже реалізовані, і що потрібно додати. В кінці — питання, де потрібне уточнення.

---

## 1. Що вже працює

| Ефект / тригер | Опис у бою | Статус |
|----------------|------------|--------|
| **melee_damage** (percent) | Бонус % до базового melee-урону (Напад Баз/Просунутий/Експерт) | ✅ Реалізовано в `calculateDamageWithModifiers` |
| **ranged_damage** (percent) | Бонус % до базового ranged-урону | ✅ Та сама логіка (matchesAttackType) |
| **counter_damage** (percent) | Урон контр-атаки = base × (1 + %/100); тригер: перший удар по цілі в раунді | ✅ `getCounterDamagePercent`, `performReaction`, `canPerformReaction` |
| **onFirstHitTakenPerRound** | Дозвіл контр-атаки (зараз — по наявності counter_damage, не по точному тригеру) | ⚠️ Логіка "перший удар за раунд" не перевіряється окремо |

---

## 2. Ефекти за категоріями

### 2.1 Пасивні (trigger: passive) — постійні модифікатори

Потрібно застосовувати при формуванні учасника або при розрахунках.

| stat | type | Приклад скіла | Що має бути в бою |
|------|------|----------------|-------------------|
| physical_resistance | percent | Захист Баз/Прос/Експерт | Зменшення фізичного урону по цілі на X% |
| all_resistance | percent | Рунна броня (гноми) | Зменшення урону всіх типів на X%? |
| spell_resistance | percent | Магічний захист | Зменшення урону від заклинань на X% |
| spell_levels | flat | Магія Світла/Темряви/Хаосу/Призиву Баз/Прос/Експерт | Дозвіл касту заклинань вищого рівня — як саме (макс рівень? додаткові слоти?)? |
| spell_slots_lvl4_5 | flat | Всезнання (маги) | Додаткові слоти 4–5 рівня — чи вже є в Character.spellSlots? |
| hp_bonus | formula "2*hero_level" | Стійкість | maxHp учасника = baseMaxHp + 2*level при старті бою? |
| damage | formula "3*floor(lost_hp_percent/10)" | Жага крові (темні ельфи) | Додатковий урон за атаку залежно від % втрачених HP — до базового урону чи окремий тип? |
| physical_damage | formula "0.05*morale" | Лідерство (пасивка) | Бонус до фізичного урону за мораль? |
| morale | flat | Лідерство Баз/Прос/Експерт, Успіх | Початкова мораль учасника +1 (або мін/макс)? |
| morale | min | Лідерство (пасивка allyHP<=15%) | Мінімум моралі 1 при умові? |
| max_targets | flat | Постріл по 2 цілям | У атаці дозволено вибирати до 2 цілей? |
| crit_threshold | flat 18 | Критичний удар | Крит при 18–20 замість лише 20? |
| dark_spell_damage | percent | Поступ смерті | +X% до урону темних заклинань |
| chaos_spell_damage | percent | Магія Хаосу пасивка | +X% до урону хаос-заклинань |
| spell_targets_lvl4_5 | flat 2 | Темна магія 3 рівень | Заклинання 4–5 рівня на 2 цілі? |
| light_spells_target_all_allies | flag | Всі заклинання світла на союзників | Заклинання світла можуть таргетити всіх союзників? |
| enemy_attack_disadvantage | flag | Захист (пасивка) | Вороги мають disadvantage при атаці по цьому учаснику? |
| control_units | flat | Лідерство (пахистка) | Контроль юнітів — що саме (призиви? союзні юніти)? |
| magic_schools, exp_gain | flag/multiplier | Аватар | Швидше за все поза боєм — не змінювати бойову сцену? |
| new_spell | flag | Нові заклинання (Призив елементаля, Корені, Аватар) | Розблоковка заклинання — через spell list персонажа? |

### 2.2 Тригер: onHit (при попаданні атакою)

| stat | type | Умова | Приклад | Питання |
|------|------|--------|---------|---------|
| bleed_damage | dice "1d4", duration 2 | onHit && rand()<0.4 | Рублячий удар | Кожен раунд 1d4 урону протягом 2 раундів — окремий DoT на ціль? |
| initiative | flat -2, duration 1 | onHit && rand()<0.4 | Оглушаючий удар, Відбиваюча стріла | -2 до ініціативи цілі на 1 раунд — коли застосовувати (наступний раунд? перерахунок порядку)? |
| armor | flat -1, duration 1 | onHit && rand()<0.4 | Пошкодження броні, Бронебійний снаряд | AC цілі -1 на 1 раунд |
| speed | percent -50, duration 1 | onHit && rand()<0.4 | Травмуючий постріл | Швидкість цілі -50% на 1 раунд — вплив на що (переміщення? порядок ходу)? |
| damage_resistance | ignore | onHit | Пробивний удар | Ця атака ігнорує опір/імунітет цілі? |
| damage | stack 2 | onHit | Послідовність | Подвійний урон від цієї атаки? чи +2 до кубиків? |
| guaranteed_hit | flag | onHit && oncePerBattle | В яблучко | Наступний постріл — автоматичне попадання (ігнорувати AC)? |
| area_damage + area_cells | percent 40, flat 9 | onHit && rand()<0.4 | Хмара стріл | Додатковий area урон 40% по 9 клітинках — як задана зона (навколо цілі? лінія)? |

### 2.3 Тригер: onAttack (коли учасник атакує)

| stat | type | Приклад | Питання |
|------|------|---------|---------|
| fire_damage | dice "1d6" | Вогняна атака | Додати 1d6 вогняного урону до кожної атаки? |
| poison_damage | dice "1d8", duration 3 | Отрута | DoT 1d8/раунд, 3 раунди? |
| area_damage | flag | Стрільба area | Атака стає area — радіус/форма? |

### 2.4 Тригер: beforeEnemyAttack

| stat | type | Приклад | Питання |
|------|------|---------|---------|
| attack_before_enemy | flag | Готовність | Якщо ворог хоче атакувати цього учасника — спочатку дати йому реакцію/удар (interrupt)? Чи це "перший удар у раунді завжди за нами"? |

### 2.5 Тригер: onKill / onAllyDeath / onLethalDamage

| stat | type | trigger | Приклад | Питання |
|------|------|--------|---------|---------|
| actions | flat 1 | onKill && oncePerBattle | Нагорода | +1 додаткова дія після вбивства (одразу в цей хід)? |
| morale_per_kill, morale_per_ally_death | flat | onKill \|\| onAllyDeath | Лідерство | +1 мораль за вбивство, -2 за смерть союзника — оновлювати мораль у логіці бою? |
| survive_lethal | flat 1 | onLethalDamage && oncePerBattle | Битва до останнього | Один раз за бій замість смерті залишитися з 1 HP? |

### 2.6 Тригер: onCast (при касті заклинання)

| stat | type | Приклад | Питання |
|------|------|---------|---------|
| spell_area | flag | Гнів праведний, Даруючий захист, тощо | Конкретне заклинання стає area (для списку в effects.spells)? |
| heal | formula "2d6+hero_level" | Вічне світло | Додаткове лікування при касті певного заклинання? |
| enemy_summon_damage | percent 50 | Вигнання | +50% урону по призовам ворога для цього касту? |
| summon_tier | flat | Відкриття воріт (демони) | Бонус до рівня призиву при bonusAction — де саме вписувати (макс рівень призиву?)? |
| resurrect_* | flat/percent | Підняття мертвих | Ресуррекція — окремий флоу (ціль, кількість, % HP)? |
| initiative, armor_reduction, speed | flat/percent, duration 1 | Сповільнення, Ослаблення, тощо | Дебаф на ціль заклинанням на 1 раунд |
| burn_damage | dice "2d6", duration 3 | Хаос вогонь | DoT вогонь на ціль |
| summon_hp, summon_damage | percent | Призив | Бонус до HP/урону призваних істот |
| spell_damage, spell_hp | percent | Призив | Бонус до урону/лікування заклинання |
| summon_count | flat 2 | Призив | Призив 2 істот за один каст? |
| caster_self_damage | percent 100 | Хаос ризик | Шанс отримати 100% урону по собі при bonusAction — окремий кидок rand()? |

### 2.7 Тригер: bonusAction

| Скіл / ефект | Питання |
|--------------|---------|
| Відкриття воріт, Мисливець (marked_targets), Перенаправлення, Відновлення слота (onConsumeDead), Заохочення (morale), Додаткові касти (twicePerBattle) | Bonus action — це окрема кнопка "Бонусна дія" з вибором скіла? Чи частина того ж UI, де вибирають атаку/заклинання? |

### 2.8 Тригер: onBattleStart / oncePerBattle / action && oncePerBattle

| stat | trigger | Приклад | Питання |
|------|--------|---------|---------|
| initiative +2, damage formula | onBattleStart | Перший удар | Бонус до ініціативи та додатковий урон один раз на початку бою? |
| field_damage | oncePerBattle | Поле бою | Один раз за бій: урон по полю (по всіх? по ворогах?) — формула hero_level/2 |
| revive_hp 50% | action && oncePerBattle | Повернення | Одна дія за бій — оживити союзника з 50% HP? |
| morale -3 | action && oncePerBattle | Паніка | Одна дія за бій: знизити мораль на 3 (свою? цілі? області?)? |
| extra_casts 2 | bonusAction && twicePerBattle | Додаткові касти | Двічі за бій бонусною дією дати 2 додаткові касти? |

### 2.9 Тригер: allyHP <= 0.15 / morale / allyMoraleCheck

| stat | trigger | Приклад | Питання |
|------|--------|---------|---------|
| clear_negative_effects | allyHP <= 0.15 && oncePerBattle | Супротив | Один раз за бій: коли союзник падає нижче 15% HP — зняти з нього дебафи? |
| morale (min) 1, damage formula | passive && allyHP <= 0.15*maxHP | Лідерство пасивка | Мораль не падає нижче 1 і додатковий урон, якщо є союзник <15% HP? |
| initiative +1, duration 1 | allyMoraleCheck && stackable | Успіх | При успішній перевірці моралі союзника — +1 ініціатива (стакується)? |
| damage +5 | onMoraleSuccess && stackable | Заохочення | При успішній моралі — +5 до наступного урону (стакується)? |
| morale_restore 0 | passive && moraleNegativeNextRound | Лідерство дебаф | Як саме "мораль негативна наступний раунд" — один раунд після чогось? |

### 2.10 Тригер: onFirstRangedAttack (пасивно)

| stat | Приклад | Питання |
|------|---------|---------|
| initiative 999, advantage | Перший дальній постріл | Перша ranged-атака в бою: учасник отримує макс ініціативу та advantage на цей постріл? |

### 2.11 Інші типи effect.type

| type | Приклади | Питання |
|------|----------|---------|
| formula | damage "3*floor(lost_hp_percent/10)", heal "2d6+hero_level", hp_bonus "2*hero_level" | Парсинг формул: lost_hp_percent, hero_level, morale — брати з поточного стану учасника/бою? |
| dice | bleed_damage "1d4", fire_damage "1d6", burn_damage "2d6" | Усі такі — додатковий урон (або DoT) з кидком кубиків? |
| stack | damage value 2 (Послідовність) | "stack" = множник урону (×2)? чи додати 2 до кубиків? |
| ignore | damage_resistance | Ігнорувати опір цілі для цієї атаки? |
| flag | guaranteed_hit, spell_area, тощо | Прапорець — вмикає механіку (наступна атака автопопадання, заклинання area, тощо). |
| min | morale 1 | Мінімальне значення стату (мораль не нижче 1). |

---

## 3. Питання для уточнення (коротко)

1. **physical_resistance / all_resistance / spell_resistance** — застосовувати як зменшення відповідного урону (відсоток від отриманого урону)? Чи є кап (наприклад, не більше 50%)?
2. **spell_levels** (flat 2/4/5) — це "можна кастувати заклинання до рівня 2/4/5" чи "додати X слотів певного рівня"?
3. **hp_bonus** "2*hero_level" — додається до maxHp при створенні учасника бою?
4. **Жага крові** (damage formula lost_hp_percent) — додатковий урон додається до того ж типу урону (фізичний), чи окремим типом?
5. **Рублячий удар / Отрута / Вогонь** (bleed_damage, poison_damage, burn_damage з duration) — DoT застосовується як окремий статус на ціль з кидком кожен раунд?
6. **Оглушаючий удар** (initiative -2, duration 1) — "наступний раунд" ціль має -2 до ініціативи при перерахунку порядку, чи це впливає лише на "наступний хід цієї цілі"?
7. **Готовність** (attack_before_enemy) — точна поведінка: "коли ворог обирає цільою мене для атаки, спочатку я можу зробити одну атаку по ньому"?
8. **Нагорода** (actions +1, onKill oncePerBattle) — додаткова дія доступна одразу в тому ж ході після вбивства (тобто можна ще раз атакувати/кастувати)?
9. **Битва до останнього** (survive_lethal oncePerBattle) — при отриманні летального урону один раз за бій замість 0 HP залишаємо 1 HP?
10. **Перенаправлення** (redirect_physical_damage 50%, bonusAction) — бонусною дією обрати союзника і половину фізичного урону по собі перенаправляти на нього?
11. **В яблучко** (guaranteed_hit oncePerBattle) — один раз за бій наступна ranged-атака автоматично влучає (без кидка d20)?
12. **Поле бою** (field_damage oncePerBattle, formula hero_level/2) — один раз за бій завдати hero_level/2 урону всім ворогам? чи всім учасникам?
13. **Демони, Відкриття воріт** (summon_tier, bonusAction) — бонусна дія "відкрити ворота" дає бонус до наступного призиву (як саме: +1/3/6 до рівня призиву)?
14. **Мораль** (morale_per_kill, morale_per_ally_death) — оновлювати поле morale учасника в initiativeOrder після кожного вбивства/смерті союзника?
15. **Перший удар** (onBattleStart: initiative +2, damage 1d4+level/3) — застосовувати до початкової ініціативи та до першої атаки цього учасника в бою?
16. **Додаткові касти** (extra_casts 2, bonusAction, twicePerBattle) — двічі за бій бонусною дією відновити 2 використані слоти (якого рівня?)?

---

## 4. Відповіді на питання (уточнення)

1. **Резисти** — працюють або повністю 100%, або на вказаний відсоток. Резист 40% зменшує відповідний урон на 40%. Типи: **фізичний** (від атак), **магічний** (від магії, що завдає шкоду).
2. **spell_levels** — відкриває доступ до певного рівня заклинань (макс рівень, який можна кастувати).
3. **hp_bonus** — так, додається до maxHp при створенні учасника бою.
4. **Жага крові** — так, додатковий урон до того ж типу (фізичний).
5. **DoT (bleed/poison/burn)** — шкода прокидується одразу з кидком при застосуванні і діє вказану кількість раундів (DoT на ціль, кожен раунд — за тим самим правилом).
6. **Оглушаючий удар (initiative -2)** — впливає на наступний раунд (перерахунок порядку в наступному раунді).
7. **Готовність** — так: коли ворог обирає мене цільою для атаки, спочатку я можу зробити одну атаку по ньому.
8. **Нагорода** — так: додаткова дія доступна одразу в тому ж ході після вбивства.
9. **Битва до останнього** — так: один раз за бій при летальному уроні залишаємо 1 HP замість 0.
10. **Перенаправлення** — так: бонусною дією обрати союзника, половина фізичного урону по собі перенаправляється на нього.
11. **В яблучко** — так: один раз за бій наступна ranged-атака автоматично влучає (без кидка d20).
12. **Поле бою (ультимативна демонів)** — на наступні **3 раунди** всі вороги того, хто використовує цю здібність, отримують шкоду на **початку раунду**.
13. **Відкриття воріт (демони)** — на поле **додається істота-демон** tier 1/3/6 (не бонус до наступного призиву, а одразу призив демона відповідного tier).
14. **Мораль** — так: оновлювати поле morale учасника після вбивства/смерті союзника.
15. **Перший удар** — потребує уточнення: який саме скіл мається на увазі (поки залишаємо питання в докі).
16. **Додаткові касти** — **не** відновлення слотів. Двічі за бій герой з цим скілом може **двічі зробити дію магією** (додаткова дія касту, не слоти).

Після цих відповідей можна реалізовувати ефекти по блоках: пасивні (резисти, spell_levels, hp_bonus, мораль), DoT, onHit-дебафи, Готовність/Нагорода/survive_lethal, bonusAction (Перенаправлення, Відкриття воріт, додаткові касти), поле бою (демони), тощо.
