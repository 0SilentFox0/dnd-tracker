# Генеральна перевірка бою: 3 герої vs 5 юнітів

## Мета

Перевірити коректність бойової системи: скіли героїв, заклинання, розрахунки урону/лікування, ініціатива, ходи за 3 раунди. Усі тест-кейси записані заздалегідь; перевірка виконується крок за кроком.

---

## 1. Передумови

### 1.1 Кампанія

- Є кампанія з ID (наприклад, з `lib/constants/campaigns.ts`: `DEFAULT_CAMPAIGN_ID`).
- У кампанії є **DM** (користувач з роллю `dm`).

### 1.2 Раси та дерева скілів

- У кампанії **не менше 3 рас** (наприклад: Human, Elf, Dwarf).
- Для кожної раси створене **дерево прокачки** (SkillTree) з прив’язкою до расових скілів і main skills.
- Скіли мають коректні `skillTriggers`, `combatStats`, `bonuses` (урон, броня, тощо) для участі в бою.

### 1.3 Заклинання

- У кампанії є заклинання різних типів (шкода, лікування, баф/дебаф), з коректними полями: `diceCount`, `diceType`, `savingThrow`, `effects`, `damageType`, `target`.

### 1.4 Бібліотека юнітів

- У кампанії є **не менше 5 юнітів** (Units) з заповненими: `maxHp`, `armorClass`, `attacks`, `initiative`, `speed`, опційно `knownSpells`.

---

## 2. Підготовка даних (що має бути створено)

### 2.1 Три персонажі, 20 рівень, різні раси

| № | Ім'я        | Раса   | Клас    | Рівень | Роль у тесті        |
|---|-------------|--------|---------|--------|----------------------|
| 1 | Герой-1     | Human  | Fighter | 20     | Меле-атаки, скіли    |
| 2 | Герой-2     | Elf    | Ranger  | 20     | Дальні атаки, скіли  |
| 3 | Герой-3     | Dwarf  | Cleric  | 20     | Заклинання, лікування|

**Параметри для 20 рівня (орієнтовно):**

- **Proficiency Bonus:** 6 (для рівня 20).
- **Spell Save DC / Spell Attack:** за формулами з `getSpellSaveDC` / `getSpellAttackBonus` (PB + модифікатор характеристики).
- **HP:** достатні для 3 раундів (наприклад, 120–180 для воїна, 100–140 для магів).
- **knownSpells:** у героя-заклинателя (наприклад, Герой-3) заповнені ID заклинань з кампанії.
- **spellSlots:** для 20 рівня відповідно до класу (наприклад, слоты 1–4 або вищі).

### 2.2 Дерево прокачки (відповідно до раси)

- Кожен персонаж має **прив’язку до дерева своєї раси** (CharacterSkills: `characterId`, `skillTreeId`, `unlockedSkills`).
- **skillTreeProgress** на персонажі містить запис для `skillTreeId` з масивом `unlockedSkills` (ID скілів, які відкриті).
- Рекомендовано відкрити по кілька скілів з різних гілок (basic/advanced), щоб перевірити:
  - пасивні бонуси (attack_bonus, armor, melee_damage тощо);
  - тригери (onBattleStart, onAttack, onHit, start_of_turn тощо);
  - заклинання, що додаються скілами (grantedSpell).

### 2.3 П’ять ворожих юнітів

- 5 окремих юнітів з бібліотеки кампанії (або 1 юніт з `quantity: 5` при додаванні в бій — залежить від реалізації).
- У кожного: `maxHp`, `armorClass`, `attacks` (мінімум одна атака з `attackBonus`, `damageDice`, `damageType`).
- Для перевірки save-заклинань можна мати різні характеристики (наприклад, Dex для Fireball).

---

## 3. Створення сцени бою

1. **POST** `/api/campaigns/[id]/battles`  
   - Body:  
     - `name`: "Тест 3v5"  
     - `participants`:  
       - 3 об’єкти `{ id: "<characterId>", type: "character", side: "ally" }` для героїв;  
       - 5 об’єктів `{ id: "<unitId>", type: "unit", side: "enemy" }` для юнітів (або один unit з `quantity: 5` якщо API підтримує).  
2. Зберегти **battleId** з відповіді.

---

## 4. Старт бою

1. **POST** `/api/campaigns/[id]/battles/[battleId]/start`
2. Перевірити у відповіді:
   - `status === "active"`;
   - `initiativeOrder` — масив учасників, відсортований за ініціативою (більше = раніше);
   - У кожного учасника є `basicInfo.id`, `combatStats.currentHp`, `combatStats.maxHp`, `combatStats.armorClass`, `combatStats.status === "active"`;
   - У героїв з скілами — масив активних скілів (наприклад, з тригерами onBattleStart), у героїв-заклинателів — `spellcasting.knownSpells`.

**Тест-кейс 0 (старт):**  
- Ініціатива розрахована (базова + бонуси з скілів, якщо є).  
- HP всіх учасників дорівнюють maxHp на початку раунду 1.  
- Поточний хід: `currentTurnIndex === 0`, тобто перший у `initiativeOrder`.

---

## 5. Тест-кейси (що мають відбутися)

Нижче — список дій і очікувань. Конкретні ID атак, заклинань і скілів залежать від вашої кампанії; у таблицях використані позначення типу «Атака 1», «Spell: Fireball» тощо.

### 5.1 Атака (Attack)

| Код | Дія | Очікування |
|-----|-----|------------|
| A1  | Атакующий використовує обрану атаку (attackId) по одній цілі; передано d20Roll, damageRolls. | Відповідь 200. У лозі: attackRoll = d20Roll + attackBonus (+ модифікатори з скілів). Успіх: totalDamage з урахуванням кубиків, модифікаторів, резистів; targetUpdated.combatStats.currentHp зменшено на finalDamage. Критичний удар (d20Roll === 20): подвійні кубики урону (або згідно правил проєкту). |
| A2  | Атака по цілі з активним дебафом (наприклад, -2 AC). | Розрахунок AC цілі враховує дебаф (AC знижено на 2). Удар або попадання обчислюється від ефективного AC. |
| A3  | Атака з скілом, що дає бонус до урону (наприклад, +X% melee_damage). | У damage breakdown присутній бонус зі скіла; finalDamage збільшено відповідно. |

### 5.2 Заклинання (Spell)

| Код | Дія | Очікування |
|-----|-----|------------|
| S1  | Кастер використовує заклинання шкоди (наприклад, Fireball) по ворогах; передано damageRolls, savingThrows (participantId + roll для кожної цілі). | Кожна ціль робить save (roll + модифікатор характеристики проти DC). При успіху — half damage (якщо onSuccess: "half"). У лозі: урон по кожній цілі, оновлені currentHp. |
| S2  | Заклинання лікування (наприклад, Cure Wounds / Heal) по союзнику. | targetIds — один союзник. currentHp збільшено на heal (dice + modifier), не вище maxHp. |
| S3  | Заклинання з ефектами (баф/дебаф з константи spell-effects). | На цілі додано ефект(и) у масив активних ефектів (наприклад, duration у раундах); при наступних розрахунках (AC, урон, save) ефекти враховані. |

### 5.3 Скіли

| Код | Дія | Очікування |
|-----|-----|------------|
| K1  | На початку бою (після start) у героїв з відкритими скілами з тригером onBattleStart. | У initiativeOrder учасники мають оновлені значення (наприклад, initiative +2), якщо скіл це надає. |
| K2  | Під час атаки героя зі скілом onAttack / onHit. | Тригер виконується; додатковий урон або ефект відображається в battleLog і в оновленні цілі/атакуючого. |
| K3  | start_of_turn / end_of_turn. | При next-turn для відповідного учасника скіли з цими тригерами виконуються; battleLog або оновлення стану відображають результат. |

### 5.4 Перехід ходу та раунду

| Код | Дія | Очікування |
|-----|-----|------------|
| T1  | POST next-turn після того, як поточний учасник завершив дії (або пропустив хід). | currentTurnIndex зміщено на наступного живого учасника; якщо кінець списку — currentRound + 1, currentTurnIndex = 0. |
| T2  | Новий раунд (currentRound 2, 3). | Викликані endRound (попередній раунд) та startOfRound (новий раунд); тригери скілів та ефекти з duration оновлені (зменшення duration на 1). |

---

## 6. План на 3 раунди (ход за ходом)

Нижче — шаблон. Заповніть конкретні `basicInfo.id` з вашого `initiativeOrder` після старту бою.

### Раунд 1

1. **Хід 1 (перший у ініціативі)**  
   - Учасник: _[ім’я/тип]_  
   - Дія: _[Attack на ціль X / Spell Y на цілі Z]_  
   - Тест-кейси: _A1 або S1, S2_  
   - Перевірити: HP цілей після дії, battleLog запис.

2. **Хід 2**  
   - Учасник: _…_  
   - Дія: _…_  
   - Тест-кейси: _…_

3. … (продовжити по кількості учасників у initiativeOrder).

4. Після останнього ходу в раунді 1: **POST next-turn** → має стати `currentRound: 2`, `currentTurnIndex: 0`.  
   - Тест-кейс: T1, T2.

### Раунд 2

- Аналогічно: для кожного ходу записати дію (атака/заклинання), код тест-кейсу та очікуваний результат (HP, лог, ефекти).
- Перевірити скіли з start_of_turn/end_of_turn (K3), якщо такі є.

### Раунд 3

- Те саме. Додатково можна перевірити умови перемоги (всі вороги мертві) або мораль (якщо реалізовано).

---

## 7. Чеклист перевірки розрахунків

- [ ] **Ініціатива:** порядок ходів відповідає initiative (вище = раніше); при рівні — згідно правил (наприклад, baseInitiative, dexterity).
- [ ] **Attack roll:** attackRoll = d20Roll + attackBonus + модифікатори з екіпірування/скілів; перевірка проти AC цілі (з урахуванням дебафів).
- [ ] **Damage:** базовий урон з damageDice + модифікатор; резисти (half/double); додатковий урон зі скілів окремо в breakdown.
- [ ] **Saving throw:** для кожної цілі save: roll + ability modifier проти spellSaveDC; onSuccess "half" / "none" застосовано до урону.
- [ ] **Лікування:** не перевищує maxHp; tempHp згідно правил проєкту.
- [ ] **Ефекти (бафи/дебафи):** duration зменшується на 1 на початку раунду або в end_of_turn; при duration 0 ефект знято.
- [ ] **Скіли:** тригери onBattleStart, onAttack, onHit, start_of_turn, end_of_turn виконуються у відповідний момент; бонуси застосовані до стану учасника.
- [ ] **Next turn / next round:** currentTurnIndex і currentRound оновлюються коректно; мертві учасники (currentHp ≤ 0 або status !== "active") пропускаються.

---

## 8. Скрипт підготовки

Для автоматичної підготовки 3 героїв (рівень 20, різні раси), 5 юнітів і сцени бою використовуйте:

```bash
npx tsx scripts/setup-battle-test-3v5.ts YOUR_CAMPAIGN_ID
```

Скрипт створить (або оновить) персонажів, юнітів і одну сцену бою в статусі `prepared`. Далі потрібно вручну або через API викликати **POST start** і провести 3 раунди за цим планом.

---

## 9. Підсумок

- Усі тест-кейси (A1–A3, S1–S3, K1–K3, T1–T2) мають бути виконані під час 3 раундів і перевірені за чеклистом розрахунків.
- Результати кожного кроку (відповіді API, battleLog, HP учасників) варто фіксувати для звіту про проходження тестів.
