generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id
  email           String           @unique
  displayName     String
  avatar          String?
  createdAt       DateTime         @default(now())
  campaignMembers CampaignMember[]
  dmCampaigns     Campaign[]       @relation("DMCampaigns")
  characters      Character[]

  @@map("users")
}

model Campaign {
  id              String           @id @default(cuid())
  name            String
  description     String?
  inviteCode      String           @unique
  dmUserId        String
  maxLevel        Int              @default(20)
  xpMultiplier    Float            @default(2.5)
  allowPlayerEdit Boolean          @default(true)
  status          String           @default("active")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  friendlyFire    Boolean          @default(false)
  artifactSets    ArtifactSet[]
  artifacts       Artifact[]
  battles         BattleScene[]
  members         CampaignMember[]
  dm              User             @relation("DMCampaigns", fields: [dmUserId], references: [id])
  characters      Character[]
  mainSkills      MainSkill[]
  races           Race[]
  racialAbilities RacialAbility[]
  skillTrees      SkillTree[]
  skills          Skill[]
  spellGroups     SpellGroup[]
  spells          Spell[]
  unitGroups      UnitGroup[]
  units           Unit[]

  @@map("campaigns")
}

model CampaignMember {
  id         String   @id @default(cuid())
  campaignId String
  userId     String
  role       String
  joinedAt   DateTime @default(now())
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@map("campaign_members")
}

model Character {
  id                   String              @id @default(cuid())
  campaignId           String
  type                 String
  controlledBy         String
  name                 String
  level                Int                 @default(1)
  class                String
  subclass             String?
  race                 String
  subrace              String?
  alignment            String?
  background           String?
  experience           Int                 @default(0)
  avatar               String?
  strength             Int                 @default(10)
  dexterity            Int                 @default(10)
  constitution         Int                 @default(10)
  intelligence         Int                 @default(10)
  wisdom               Int                 @default(10)
  charisma             Int                 @default(10)
  armorClass           Int                 @default(10)
  initiative           Int                 @default(0)
  speed                Int                 @default(30)
  maxHp                Int                 @default(10)
  currentHp            Int                 @default(10)
  tempHp               Int                 @default(0)
  hitDice              String              @default("1d8")
  proficiencyBonus     Int                 @default(2)
  savingThrows         Json                @default("{}")
  skills               Json                @default("{}")
  passivePerception    Int                 @default(10)
  passiveInvestigation Int                 @default(10)
  passiveInsight       Int                 @default(10)
  spellcastingClass    String?
  spellcastingAbility  String?
  spellSaveDC          Int?
  spellAttackBonus     Int?
  spellSlots           Json                @default("{}")
  knownSpells          Json                @default("[]")
  languages            Json                @default("[]")
  proficiencies        Json                @default("{}")
  personalityTraits    String?
  ideals               String?
  bonds                String?
  flaws                String?
  skillTreeProgress    Json                @default("{}")
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  immunities           Json                @default("[]")
  morale               Int                 @default(0)
  maxTargets           Int                 @default(1)
  minTargets           Int                 @default(1)
  personalSkillId      String?
  inventory            CharacterInventory?
  characterSkills      CharacterSkills[]
  campaign             Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user                 User                @relation(fields: [controlledBy], references: [id], onDelete: SetNull)

  @@map("characters")
}

model Unit {
  id               String     @id @default(cuid())
  campaignId       String
  name             String
  groupId          String?
  groupColor       String?
  level            Int        @default(1)
  strength         Int        @default(10)
  dexterity        Int        @default(10)
  constitution     Int        @default(10)
  intelligence     Int        @default(10)
  wisdom           Int        @default(10)
  charisma         Int        @default(10)
  armorClass       Int        @default(10)
  initiative       Int        @default(0)
  speed            Int        @default(30)
  maxHp            Int        @default(10)
  proficiencyBonus Int        @default(2)
  attacks          Json       @default("[]")
  specialAbilities Json       @default("[]")
  knownSpells      Json       @default("[]")
  avatar           String?
  createdAt        DateTime   @default(now())
  damageModifier   String?
  immunities       Json       @default("[]")
  race             String?
  morale           Int        @default(0)
  maxTargets       Int        @default(1)
  minTargets       Int        @default(1)
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  unitGroup        UnitGroup? @relation(fields: [groupId], references: [id])

  @@map("units")
}

model UnitGroup {
  id             String   @id @default(cuid())
  campaignId     String
  name           String
  color          String
  createdAt      DateTime @default(now())
  damageModifier String?
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  units          Unit[]

  @@map("unit_groups")
}

model Spell {
  id               String      @id @default(cuid())
  campaignId       String
  name             String
  level            Int         @default(0)
  type             String
  damageType       String
  castingTime      String?
  range            String?
  components       String?
  duration         String?
  concentration    Boolean     @default(false)
  savingThrow      Json?
  description      String
  groupId          String?
  createdAt        DateTime    @default(now())
  damageElement    String?
  icon             String?
  target           String?
  damageModifier   String?
  healModifier     String?
  diceCount        Int?
  diceType         String?
  skills              Skill[]
  skillsAsNewSpell     Skill[]  @relation("SkillNewSpell")
  skillsGrantingSpell Skill[]  @relation("SkillGrantedSpell")
  campaign            Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  spellGroup          SpellGroup? @relation(fields: [groupId], references: [id])

  @@map("spells")
}

model SpellGroup {
  id         String   @id @default(cuid())
  campaignId String
  name       String
  createdAt  DateTime @default(now())
  skills     Skill[]
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  spells     Spell[]

  @@map("spell_groups")
}

model Artifact {
  id             String       @id @default(cuid())
  campaignId     String
  name           String
  description    String?
  rarity         String?
  slot           String
  bonuses        Json         @default("{}")
  modifiers      Json         @default("[]")
  passiveAbility Json?
  setId          String?
  icon           String?
  createdAt      DateTime     @default(now())
  campaign       Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  artifactSet    ArtifactSet? @relation(fields: [setId], references: [id])

  @@map("artifacts")
}

model ArtifactSet {
  id          String     @id @default(cuid())
  campaignId  String
  name        String
  description String?
  artifactIds Json       @default("[]")
  setBonus    Json?
  createdAt   DateTime   @default(now())
  campaign    Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  artifacts   Artifact[]

  @@map("artifact_sets")
}

model CharacterInventory {
  id          String    @id @default(cuid())
  characterId String    @unique
  equipped    Json      @default("{}")
  backpack    Json      @default("[]")
  gold        Int       @default(0)
  silver      Int       @default(0)
  copper      Int       @default(0)
  items       Json      @default("[]")
  updatedAt   DateTime  @updatedAt
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_inventories")
}

model SkillTree {
  id              String            @id @default(cuid())
  campaignId      String
  race            String
  skills          Json              @default("[]")
  createdAt       DateTime          @default(now())
  characterSkills CharacterSkills[]
  campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("skill_trees")
}

model CharacterSkills {
  id             String    @id @default(cuid())
  characterId    String
  skillTreeId    String
  unlockedSkills Json      @default("[]")
  updatedAt      DateTime  @updatedAt
  character      Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  skillTree      SkillTree @relation(fields: [skillTreeId], references: [id], onDelete: Cascade)

  @@unique([characterId, skillTreeId])
  @@map("character_skills")
}

model BattleScene {
  id               String    @id @default(cuid())
  campaignId       String
  name             String
  description      String?
  status           String    @default("prepared")
  participants     Json      @default("[]")
  currentRound     Int       @default(1)
  currentTurnIndex Int       @default(0)
  initiativeOrder  Json      @default("[]")
  pendingSummons   Json      @default("[]")
  battleLog        Json      @default("[]")
  createdAt        DateTime  @default(now())
  startedAt        DateTime?
  completedAt      DateTime?
  campaign         Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("battle_scenes")
}

model StatusEffect {
  id          String  @id @default(cuid())
  name        String
  type        String
  condition   String?
  description String
  effects     Json    @default("[]")
  icon        String?
  color       String?

  @@map("status_effects")
}

model RacialAbility {
  id          String   @id @default(cuid())
  campaignId  String
  race        String
  name        String
  description String
  type        String
  trigger     Json?
  effect      Json
  appliesTo   Json?
  createdAt   DateTime @default(now())
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("racial_abilities")
}

model Skill {
  id                      String      @id @default(cuid())
  campaignId              String
  name                    String      @default("")
  description             String?
  bonuses                 Json        @default("{}")
  damage                  Int?
  armor                   Int?
  speed                   Int?
  physicalResistance      Int?
  magicalResistance       Int?
  spellId                 String?
  spellGroupId            String?
  createdAt               DateTime    @default(now())
  icon                    String?
  image                   String?
  mainSkillId             String?
  spellEnhancementTypes   Json        @default("[]")
  spellEffectIncrease     Int?
  spellTargetChange       Json?
  spellAdditionalModifier Json?
  spellNewSpellId         String?
  grantedSpellId          String?     // скіл додає це заклинання персонажу
  skillTriggers           Json        @default("[]")
  basicInfo               Json        @default("{}")
  combatStats             Json        @default("{}")
  mainSkillData           Json        @default("{}")
  spellData               Json        @default("{}")
  spellEnhancementData    Json        @default("{}")
  campaign                Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  mainSkill               MainSkill?  @relation(fields: [mainSkillId], references: [id])
  spellGroup              SpellGroup? @relation(fields: [spellGroupId], references: [id])
  spell                   Spell?      @relation(fields: [spellId], references: [id])
  spellNewSpell           Spell?      @relation("SkillNewSpell", fields: [spellNewSpellId], references: [id])
  grantedSpell             Spell?      @relation("SkillGrantedSpell", fields: [grantedSpellId], references: [id])

  @@map("skills")
}

model Race {
  id                   String   @id @default(cuid())
  campaignId           String
  name                 String
  availableSkills      Json     @default("[]")
  disabledSkills       Json     @default("[]")
  passiveAbility       Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  spellSlotProgression Json     @default("[]")
  campaign             Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("races")
}

model MainSkill {
  id                  String   @id @default(cuid())
  campaignId           String
  name                 String
  color                String
  icon                 String?
  isEnableInSkillTree  Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  campaign             Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  skills               Skill[]

  @@map("main_skills")
}
